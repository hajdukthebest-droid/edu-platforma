// Prisma Schema za Edu Platforma
// Database: PostgreSQL 16+

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

// ============================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  INSTRUCTOR
  LEARNER
  MANAGER
  PHARMACIST
  PHARMACY_TECHNICIAN
  MEDICAL_REP
  CLINICAL_RESEARCHER
  REGULATOR
}

enum LearningStyle {
  VISUAL
  AUDITORY
  KINESTHETIC
  READING_WRITING
}

enum LearningPace {
  SLOW
  MODERATE
  FAST
}

model User {
  id                String         @id @default(cuid())
  email             String         @unique
  emailVerified     DateTime?
  username          String?        @unique
  password          String?
  firstName         String?
  lastName          String?
  avatar            String?
  bio               String?
  phone             String?
  dateOfBirth       DateTime?
  role              UserRole       @default(LEARNER)

  // Professional info
  profession        String?
  licenseNumber     String?
  organization      String?
  department        String?
  jobTitle          String?

  // Learning preferences
  learningStyle     LearningStyle?
  learningPace      LearningPace?
  preferredLanguage String         @default("hr")
  timezone          String         @default("Europe/Zagreb")
  preferredDomains  String[]       @default([]) // User's preferred learning domains

  // Gamification
  totalPoints       Int            @default(0)
  level             Int            @default(1)
  currentStreak     Int            @default(0)
  longestStreak     Int            @default(0)
  lastActivityDate  DateTime?

  // Settings
  emailNotifications Boolean       @default(true)
  pushNotifications  Boolean       @default(true)
  marketingEmails    Boolean       @default(false)
  isActive          Boolean        @default(true)
  isVerified        Boolean        @default(false)

  // Timestamps
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  lastLoginAt       DateTime?

  // Relations
  accounts          Account[]
  sessions          Session[]
  enrollments       Enrollment[]
  courseProgress    CourseProgress[]
  lessonProgress    LessonProgress[]
  assessmentAttempts AssessmentAttempt[]
  certificates      Certificate[]
  badges            UserBadge[]
  achievements      UserAchievement[]
  forumPosts        ForumPost[]
  forumComments     ForumComment[]
  forumVotes        ForumVote[]
  reviews           Review[]
  notes             Note[]
  bookmarks         Bookmark[]
  notifications     Notification[]
  createdCourses    Course[]       @relation("CourseCreator")
  payments          Payment[]
  subscriptions     Subscription[]
  learningPathsCreated LearningPath[] @relation("LearningPathsCreated")
  userLearningPaths UserLearningPath[]
  conversationsAsParticipant1 Conversation[] @relation("ConversationsAsParticipant1")
  conversationsAsParticipant2 Conversation[] @relation("ConversationsAsParticipant2")
  messagesSent      Message[]      @relation("MessagesSent")
  instructorSessions LiveSession[] @relation("InstructorSessions")
  sessionAttendance LiveSessionAttendance[]
  sessionMessages   LiveSessionMessage[]
  courseVersions    CourseVersion[] @relation("CourseVersions")
  moduleVersions    ModuleVersion[] @relation("ModuleVersions")
  lessonVersions    LessonVersion[] @relation("LessonVersions")
  videoQuizResponses VideoQuizResponse[] @relation("VideoQuizResponses")
  flashcardDecks    FlashcardDeck[] @relation("FlashcardDecksCreated")
  flashcardReviews  FlashcardReview[] @relation("FlashcardReviews")
  examSessions      ExamSession[] @relation("ExamSessions")
  studyGroupsCreated StudyGroup[] @relation("StudyGroupsCreated")
  studyGroupMemberships StudyGroupMember[] @relation("StudyGroupMemberships")
  studyGroupMessages StudyGroupMessage[] @relation("StudyGroupMessages")
  studyGroupResources StudyGroupResource[] @relation("StudyGroupResources")
  studySessionsCreated StudySession[] @relation("StudySessionsCreated")
  studyGroupInvitesSent StudyGroupInvite[] @relation("StudyGroupInvitesSent")
  learningStreak    LearningStreak? @relation("UserLearningStreak")
  streakRewards     StreakReward[] @relation("UserStreakRewards")
  assignmentsCreated Assignment[] @relation("InstructorAssignments")
  submissions       AssignmentSubmission[] @relation("StudentSubmissions")
  peerReviews       PeerReview[] @relation("ReviewerReviews")
  promoCodeUsages   PromoCodeUsage[] @relation("UserPromoUsages")

  @@index([email])
  @@index([role])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// COURSE MANAGEMENT
// ============================================

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Domain represents main industry/field (IT, Healthcare, Business, etc.)
model Domain {
  id          String     @id @default(cuid())
  name        String     @unique
  slug        String     @unique
  description String?
  icon        String?    // Icon/emoji for the domain
  color       String?    // Brand color for the domain
  coverImage  String?    // Cover image for domain landing page
  order       Int        @default(0) // Display order
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  categories  Category[]

  @@map("domains")
}

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  icon        String?
  domainId    String?    // Link to parent domain
  domain      Domain?    @relation(fields: [domainId], references: [id], onDelete: SetNull)
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  courses     Course[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([domainId])
  @@map("categories")
}

model Course {
  id                String        @id @default(cuid())
  title             String
  slug              String        @unique
  description       String?
  shortDescription  String?
  thumbnail         String?
  coverImage        String?

  // Course details
  level             CourseLevel   @default(BEGINNER)
  status            CourseStatus  @default(DRAFT)
  language          String        @default("hr")
  duration          Int?          // minutes
  price             Decimal       @default(0) @db.Decimal(10, 2)

  // Metadata
  tags              String[]
  learningObjectives String[]
  requirements      String[]
  targetAudience    String?

  // Gamification
  pointsReward      Int           @default(100)

  // CPD/CME
  cpdPoints         Float?
  cmeCredits        Float?
  accreditedBy      String?

  // Stats
  enrollmentCount   Int           @default(0)
  completionCount   Int           @default(0)
  averageRating     Float?
  totalReviews      Int           @default(0)
  viewCount         Int           @default(0)

  // Relations
  creatorId         String
  creator           User          @relation("CourseCreator", fields: [creatorId], references: [id])
  categoryId        String?
  category          Category?     @relation(fields: [categoryId], references: [id])

  modules           Module[]
  enrollments       Enrollment[]
  progress          CourseProgress[]
  reviews           Review[]
  certificates      Certificate[]
  learningPaths     LearningPathCourse[]
  translations      CourseTranslation[]
  versions          CourseVersion[]
  flashcardDecks    FlashcardDeck[]
  studyGroups       StudyGroup[]
  assignments       Assignment[]  @relation("CourseAssignments")
  bundles           BundleCourse[] @relation("BundleCourses")

  // Timestamps
  publishedAt       DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([slug])
  @@index([status])
  @@index([creatorId])
  @@map("courses")
}

model Module {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String?
  orderIndex  Int
  duration    Int?     // minutes

  course       Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons      Lesson[]
  translations ModuleTranslation[]
  versions     ModuleVersion[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([courseId, orderIndex])
  @@map("modules")
}

enum LessonType {
  VIDEO
  ARTICLE
  QUIZ
  ASSIGNMENT
  LIVE_SESSION
  INTERACTIVE
  SCORM
  DOCUMENT
}

model Lesson {
  id          String     @id @default(cuid())
  moduleId    String
  title       String
  description String?
  type        LessonType
  orderIndex  Int
  duration    Int?       // minutes

  // Content
  content     String?    // Rich text for articles
  contentBlocks Json?    // Flexible content blocks (code, quiz, interactive)
  videoUrl    String?
  videoProvider String?  // 'youtube', 'vimeo', 'mux', 'self-hosted'
  videoDuration Int?
  attachments String[]   // File URLs

  // Template & Builder
  templateId  String?    // Reference to content template used
  isDraft     Boolean    @default(true)

  // Settings
  isPreview   Boolean    @default(false)
  isMandatory Boolean    @default(true)
  pointsReward Int       @default(20)

  module       Module              @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress     LessonProgress[]
  notes        Note[]
  bookmarks    Bookmark[]
  translations LessonTranslation[]
  versions     LessonVersion[]
  videoQuizzes VideoQuiz[]
  flashcardDecks FlashcardDeck[]
  assignments    Assignment[] @relation("LessonAssignments")

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([moduleId, orderIndex])
  @@map("lessons")
}

// Content Templates for Course Builder
enum TemplateCategory {
  INTRODUCTION
  THEORY
  PRACTICAL
  ASSESSMENT
  DISCUSSION
  PROJECT
}

model ContentTemplate {
  id          String            @id @default(cuid())
  name        String
  description String?
  category    TemplateCategory
  lessonType  LessonType

  // Template structure
  contentStructure Json          // JSON structure for content blocks
  thumbnail   String?

  // Usage tracking
  usageCount  Int               @default(0)
  isPublic    Boolean           @default(true)
  createdById String?

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([category])
  @@index([lessonType])
  @@map("content_templates")
}

// ============================================
// ASSESSMENTS & QUIZZES
// ============================================

enum AssessmentType {
  QUIZ
  EXAM
  ASSIGNMENT
  SURVEY
  PRACTICE
}

model Assessment {
  id              String         @id @default(cuid())
  courseId        String?
  lessonId        String?        // Link to lesson for in-lesson quizzes
  moduleId        String?        // Link to module for module-end quizzes
  title           String
  description     String?
  type            AssessmentType @default(QUIZ)

  // Settings
  timeLimit       Int?           // minutes
  passingScore    Int            @default(70) // percentage
  maxAttempts     Int?           // null = unlimited
  shuffleQuestions Boolean       @default(false)
  shuffleAnswers  Boolean        @default(false)
  showResults     Boolean        @default(true)
  showCorrectAnswers Boolean     @default(true)

  // Advanced settings
  requiresManualGrading Boolean  @default(false) // If contains essay questions
  isPublished     Boolean        @default(false)
  randomizeQuestions Int?        // Number of random questions to show (null = all)

  // Timed Exam Settings
  isTimedExam     Boolean        @default(false) // Enable strict timing
  autoSubmit      Boolean        @default(true)  // Auto-submit when time expires
  showTimer       Boolean        @default(true)  // Display countdown timer
  allowPause      Boolean        @default(false) // Allow pausing exam
  proctorMode     Boolean        @default(false) // Enable proctoring features
  requireFullscreen Boolean      @default(false) // Must be in fullscreen
  preventCopyPaste Boolean       @default(false) // Block copy/paste
  showOneQuestion Boolean        @default(false) // Show one question at a time
  allowBackNavigation Boolean    @default(true)  // Can go back to previous questions

  // Timing
  availableFrom   DateTime?      // When quiz becomes available
  availableUntil  DateTime?      // When quiz expires

  // Gamification
  pointsReward    Int            @default(50)

  questions       Question[]
  attempts        AssessmentAttempt[]
  examSessions    ExamSession[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@map("assessments")
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
  FILL_BLANK
  MATCHING
  ORDERING
}

model Question {
  id              String       @id @default(cuid())
  assessmentId    String
  type            QuestionType
  question        String
  explanation     String?
  points          Int          @default(1)
  orderIndex      Int

  // For multiple choice
  options         Json?        // Array of options
  correctAnswers  Json?        // Array of correct answer indices

  assessment      Assessment   @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("questions")
}

enum GradingStatus {
  NOT_GRADED
  PENDING
  GRADED
  NEEDS_REVISION
}

model AssessmentAttempt {
  id            String        @id @default(cuid())
  assessmentId  String
  userId        String

  answers       Json          // User's answers per question
  score         Float
  totalPoints   Int
  earnedPoints  Int
  passed        Boolean
  timeSpent     Int?          // seconds

  // Manual grading support
  gradingStatus GradingStatus @default(NOT_GRADED)
  gradedBy      String?       // Instructor ID who graded
  gradedAt      DateTime?
  feedback      String?       // Overall feedback from instructor

  // Timed Exam Tracking
  remainingTime Int?          // seconds remaining (for paused exams)
  pausedAt      DateTime?     // When exam was paused
  pauseCount    Int           @default(0) // Number of times paused
  warningsIssued Json?        // Array of proctoring warnings

  startedAt     DateTime      @default(now())
  completedAt   DateTime?

  assessment    Assessment    @relation(fields: [assessmentId], references: [id])
  user          User          @relation(fields: [userId], references: [id])
  questionAttempts QuestionAttempt[]

  @@map("assessment_attempts")
}

// Detailed tracking of individual question attempts
model QuestionAttempt {
  id              String            @id @default(cuid())
  attemptId       String
  questionId      String

  answer          Json              // User's answer
  isCorrect       Boolean?          // null for ungraded
  pointsEarned    Float             @default(0)

  // Manual grading
  instructorFeedback String?

  attempt         AssessmentAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  createdAt       DateTime          @default(now())

  @@map("question_attempts")
}

enum ExamSessionStatus {
  ACTIVE        // Exam in progress
  PAUSED        // Exam paused
  COMPLETED     // Exam finished
  EXPIRED       // Time ran out
  ABANDONED     // User left without finishing
}

// Real-time tracking of active exam sessions
model ExamSession {
  id            String            @id @default(cuid())
  assessmentId  String
  attemptId     String?           // Link to attempt when created
  userId        String

  status        ExamSessionStatus @default(ACTIVE)

  // Time tracking
  timeLimit     Int               // Total time in seconds
  timeRemaining Int               // Seconds remaining
  timeElapsed   Int               @default(0) // Total time spent

  // Session data
  currentQuestion Int?            // Current question index (for one-at-a-time mode)
  answers       Json?             // Temporary answers storage

  // Proctoring data
  fullscreenExits Int             @default(0) // Number of fullscreen exits
  tabSwitches   Int               @default(0) // Number of tab switches
  suspiciousActivity Json?        // Array of suspicious events

  // Timestamps
  startedAt     DateTime          @default(now())
  lastActivity  DateTime          @default(now()) // Last action timestamp
  pausedAt      DateTime?
  completedAt   DateTime?
  expiresAt     DateTime          // When session will auto-expire

  // Relations
  assessment    Assessment        @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  user          User              @relation("ExamSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([assessmentId])
  @@index([status])
  @@map("exam_sessions")
}

// ============================================
// PROGRESS TRACKING
// ============================================

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  DROPPED
  EXPIRED
}

model Enrollment {
  id              String           @id @default(cuid())
  userId          String
  courseId        String
  status          EnrollmentStatus @default(ACTIVE)

  startedAt       DateTime         @default(now())
  completedAt     DateTime?
  lastAccessedAt  DateTime?
  expiresAt       DateTime?

  user            User             @relation(fields: [userId], references: [id])
  course          Course           @relation(fields: [courseId], references: [id])

  @@unique([userId, courseId])
  @@map("enrollments")
}

model CourseProgress {
  id                String   @id @default(cuid())
  userId            String
  courseId          String

  completedLessons  Int      @default(0)
  totalLessons      Int
  progressPercentage Float   @default(0)

  totalTimeSpent    Int      @default(0) // seconds
  lastAccessedAt    DateTime?

  user              User     @relation(fields: [userId], references: [id])
  course            Course   @relation(fields: [courseId], references: [id])

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId, courseId])
  @@map("course_progress")
}

model LessonProgress {
  id            String   @id @default(cuid())
  userId        String
  lessonId      String

  isCompleted   Boolean  @default(false)
  completedAt   DateTime?
  timeSpent     Int      @default(0) // seconds
  lastPosition  Int?     // for video position

  user          User     @relation(fields: [userId], references: [id])
  lesson        Lesson   @relation(fields: [lessonId], references: [id])

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, lessonId])
  @@map("lesson_progress")
}

// ============================================
// CERTIFICATES
// ============================================

model Certificate {
  id              String   @id @default(cuid())
  userId          String
  courseId        String

  certificateNumber String @unique
  title           String
  description     String?

  issueDate       DateTime @default(now())
  expiryDate      DateTime?

  pdfUrl          String?
  blockchainHash  String?  // For blockchain verification

  // Verification
  verificationUrl String?
  qrCode          String?

  user            User     @relation(fields: [userId], references: [id])
  course          Course   @relation(fields: [courseId], references: [id])

  createdAt       DateTime @default(now())

  @@index([certificateNumber])
  @@map("certificates")
}

// ============================================
// GAMIFICATION
// ============================================

enum BadgeType {
  COMPLETION
  SKILL
  SOCIAL
  STREAK
  SPECIAL
}

model Badge {
  id          String    @id @default(cuid())
  name        String
  description String
  icon        String
  type        BadgeType
  criteria    Json      // Criteria to earn the badge
  pointsValue Int       @default(0)

  userBadges  UserBadge[]

  createdAt   DateTime  @default(now())

  @@map("badges")
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String

  earnedAt  DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  badge     Badge    @relation(fields: [badgeId], references: [id])

  @@unique([userId, badgeId])
  @@map("user_badges")
}

model Achievement {
  id          String   @id @default(cuid())
  name        String
  description String
  icon        String
  points      Int      @default(0)
  criteria    Json

  userAchievements UserAchievement[]

  createdAt   DateTime @default(now())

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String

  progress      Int         @default(0)
  isCompleted   Boolean     @default(false)
  completedAt   DateTime?

  user          User        @relation(fields: [userId], references: [id])
  achievement   Achievement @relation(fields: [achievementId], references: [id])

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

// ============================================
// SOCIAL LEARNING
// ============================================

model ForumCategory {
  id          String      @id @default(cuid())
  name        String
  description String?
  orderIndex  Int

  posts       ForumPost[]

  createdAt   DateTime    @default(now())

  @@map("forum_categories")
}

model ForumPost {
  id          String        @id @default(cuid())
  categoryId  String
  authorId    String

  // Q&A Context
  courseId    String?       // Link to course for course discussions
  lessonId    String?       // Link to lesson for lesson-specific questions

  title       String
  content     String
  tags        String[]      @default([]) // Tags for better organization

  isPinned    Boolean       @default(false)
  isLocked    Boolean       @default(false)

  // Q&A Features
  isSolved    Boolean       @default(false) // Has an accepted answer
  bestAnswerId String?      // The comment marked as best answer

  viewCount   Int           @default(0)
  upvotes     Int           @default(0)
  downvotes   Int           @default(0)

  category    ForumCategory @relation(fields: [categoryId], references: [id])
  author      User          @relation(fields: [authorId], references: [id])
  comments    ForumComment[]
  votes       ForumVote[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([courseId])
  @@index([lessonId])
  @@index([isSolved])
  @@map("forum_posts")
}

model ForumComment {
  id          String   @id @default(cuid())
  postId      String
  authorId    String

  // Threading support
  parentCommentId String? // For nested replies
  parentComment   ForumComment?  @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies         ForumComment[] @relation("CommentReplies")

  content     String
  upvotes     Int      @default(0)
  downvotes   Int      @default(0)

  // Q&A Features
  isBestAnswer Boolean @default(false) // Marked as best answer by post author

  post        ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author      User      @relation(fields: [authorId], references: [id])
  votes       ForumVote[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([postId])
  @@index([parentCommentId])
  @@map("forum_comments")
}

enum VoteType {
  UP
  DOWN
}

model ForumVote {
  id        String   @id @default(cuid())
  userId    String

  // Either postId or commentId will be set
  postId    String?
  commentId String?

  voteType  VoteType

  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      ForumPost?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment   ForumComment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Prevent duplicate votes - user can only vote once per post or comment
  @@unique([userId, postId])
  @@unique([userId, commentId])
  @@index([userId])
  @@index([postId])
  @@index([commentId])
  @@map("forum_votes")
}

model Review {
  id        String   @id @default(cuid())
  courseId  String
  userId    String

  rating    Int      // 1-5
  comment   String?

  course    Course   @relation(fields: [courseId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courseId, userId])
  @@map("reviews")
}

model Note {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String

  content   String
  timestamp Int?     // Video timestamp if applicable

  user      User     @relation(fields: [userId], references: [id])
  lesson    Lesson   @relation(fields: [lessonId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notes")
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String

  user      User     @relation(fields: [userId], references: [id])
  lesson    Lesson   @relation(fields: [lessonId], references: [id])

  createdAt DateTime @default(now())

  @@unique([userId, lessonId])
  @@map("bookmarks")
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  COURSE_UPDATE
  NEW_CONTENT
  ACHIEVEMENT
  BADGE
  CERTIFICATE
  REMINDER
  SOCIAL
  SYSTEM
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType

  title     String
  message   String
  link      String?

  isRead    Boolean          @default(false)
  readAt    DateTime?

  user      User             @relation(fields: [userId], references: [id])

  createdAt DateTime         @default(now())

  @@map("notifications")
}

// ============================================
// PAYMENTS & SUBSCRIPTIONS
// ============================================

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Payment {
  id              String        @id @default(cuid())
  userId          String

  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("EUR")
  status          PaymentStatus @default(PENDING)

  stripePaymentId String?
  paymentMethod   String?

  // What was purchased
  courseId        String?
  subscriptionId  String?
  bundleId        String?

  // Discount applied
  originalAmount  Decimal?      @db.Decimal(10, 2)
  discountAmount  Decimal?      @db.Decimal(10, 2)

  user            User          @relation(fields: [userId], references: [id])
  bundle          CourseBundle? @relation("BundlePayments", fields: [bundleId], references: [id])
  promoCodeUsage  PromoCodeUsage? @relation("PaymentPromoUsage")

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([bundleId])
  @@map("payments")
}

enum SubscriptionPlan {
  FREE
  BASIC
  PRO
  TEAM
  BUSINESS
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
}

model Subscription {
  id                String             @id @default(cuid())
  userId            String

  plan              SubscriptionPlan
  status            SubscriptionStatus @default(ACTIVE)

  stripeSubscriptionId String?
  stripePriceId     String?

  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean           @default(false)
  cancelledAt        DateTime?

  user              User               @relation(fields: [userId], references: [id])

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@map("subscriptions")
}

// ============================================
// LEARNING PATHS
// ============================================

model LearningPath {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  description String?
  thumbnail   String?

  level       CourseLevel?
  estimatedHours Int?

  isPublished Boolean  @default(false)
  creatorId   String

  creator     User     @relation("LearningPathsCreated", fields: [creatorId], references: [id])
  courses     LearningPathCourse[]
  userPaths   UserLearningPath[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("learning_paths")
}

model LearningPathCourse {
  id              String       @id @default(cuid())
  learningPathId  String
  courseId        String
  orderIndex      Int

  learningPath    LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  course          Course       @relation(fields: [courseId], references: [id])

  createdAt       DateTime     @default(now())

  @@unique([learningPathId, courseId])
  @@map("learning_path_courses")
}

model UserLearningPath {
  id              String       @id @default(cuid())
  userId          String
  learningPathId  String

  currentCourseIndex Int       @default(0)
  completedCourses   Int       @default(0)
  progressPercentage Float     @default(0)

  isCompleted     Boolean      @default(false)
  completedAt     DateTime?

  user            User         @relation(fields: [userId], references: [id])
  learningPath    LearningPath @relation(fields: [learningPathId], references: [id])

  startedAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([userId, learningPathId])
  @@map("user_learning_paths")
}

// ============================================
// ANALYTICS
// ============================================

model AnalyticsEvent {
  id         String   @id @default(cuid())
  userId     String?

  eventType  String
  eventData  Json

  // Context
  ipAddress  String?
  userAgent  String?
  sessionId  String?

  createdAt  DateTime @default(now())

  @@index([eventType])
  @@index([userId])
  @@map("analytics_events")
}

// ============================================
// LIVE STREAMING & WEBINARS
// ============================================

enum LiveSessionStatus {
  SCHEDULED
  LIVE
  ENDED
  CANCELLED
}

model LiveSession {
  id          String            @id @default(cuid())
  courseId    String?
  instructorId String

  title       String
  description String?

  // Scheduling
  scheduledStartTime DateTime
  scheduledEndTime   DateTime
  actualStartTime    DateTime?
  actualEndTime      DateTime?

  // YouTube Live Integration
  youtubeVideoId String?           // YouTube video ID for live stream
  recordingUrl   String?           // URL to recording after session ends
  chatEnabled    Boolean           @default(true)

  // Settings
  status         LiveSessionStatus @default(SCHEDULED)
  maxAttendees   Int?              // Optional attendance limit
  isRecorded     Boolean           @default(true)
  allowQuestions Boolean           @default(true)

  // Relations
  instructor  User                    @relation("InstructorSessions", fields: [instructorId], references: [id])
  attendance  LiveSessionAttendance[]
  messages    LiveSessionMessage[]

  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  @@index([courseId])
  @@index([instructorId])
  @@index([scheduledStartTime])
  @@index([status])
  @@map("live_sessions")
}

model LiveSessionAttendance {
  id        String   @id @default(cuid())
  sessionId String
  userId    String

  joinedAt  DateTime @default(now())
  leftAt    DateTime?
  watchTime Int      @default(0) // seconds

  session   LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@map("live_session_attendance")
}

model LiveSessionMessage {
  id         String   @id @default(cuid())
  sessionId  String
  userId     String

  message    String
  isQuestion Boolean  @default(false) // Q&A question
  isAnswered Boolean  @default(false) // Has instructor answered
  isPinned   Boolean  @default(false) // Pinned by instructor

  session    LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@index([sessionId])
  @@index([userId])
  @@index([isQuestion])
  @@map("live_session_messages")
}

// ============================================
// MESSAGING
// ============================================

model Conversation {
  id        String   @id @default(cuid())

  // Participants
  participant1Id String
  participant2Id String

  // Last message info for quick access
  lastMessageAt  DateTime?
  lastMessageText String?

  // Read status
  participant1Unread Int @default(0)
  participant2Unread Int @default(0)

  participant1 User @relation("ConversationsAsParticipant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2 User @relation("ConversationsAsParticipant2", fields: [participant2Id], references: [id], onDelete: Cascade)

  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([participant1Id, participant2Id])
  @@index([participant1Id])
  @@index([participant2Id])
  @@map("conversations")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String

  content        String
  isRead         Boolean  @default(false)

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}

// ============================================
// MULTI-LANGUAGE SUPPORT
// ============================================

enum SupportedLocale {
  HR // Croatian
  EN // English
}

model CourseTranslation {
  id          String          @id @default(cuid())
  courseId    String
  locale      SupportedLocale

  // Translated fields
  title             String
  description       String?
  shortDescription  String?
  learningObjectives String[]
  requirements      String[]
  targetAudience    String?

  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([courseId, locale])
  @@index([courseId])
  @@map("course_translations")
}

model ModuleTranslation {
  id          String          @id @default(cuid())
  moduleId    String
  locale      SupportedLocale

  // Translated fields
  title       String
  description String?

  module      Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([moduleId, locale])
  @@index([moduleId])
  @@map("module_translations")
}

model LessonTranslation {
  id          String          @id @default(cuid())
  lessonId    String
  locale      SupportedLocale

  // Translated fields
  title       String
  description String?
  content     String?

  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([lessonId, locale])
  @@index([lessonId])
  @@map("lesson_translations")
}

// ============================================
// CONTENT VERSIONING & ROLLBACK
// ============================================

model CourseVersion {
  id          String   @id @default(cuid())
  courseId    String
  version     Int      // Incremental version number

  // Snapshot of course data at this version
  title             String
  description       String?
  shortDescription  String?
  level             String
  language          String
  duration          Int?
  price             Decimal  @db.Decimal(10, 2)
  tags              String[]
  learningObjectives String[]
  requirements      String[]
  targetAudience    String?

  // Metadata
  changeDescription String?  // What changed in this version
  createdById       String
  createdBy         User     @relation("CourseVersions", fields: [createdById], references: [id])

  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([courseId, version])
  @@index([courseId])
  @@map("course_versions")
}

model ModuleVersion {
  id          String   @id @default(cuid())
  moduleId    String
  version     Int

  // Snapshot of module data
  title       String
  description String?
  orderIndex  Int
  duration    Int?

  // Metadata
  changeDescription String?
  createdById       String
  createdBy         User     @relation("ModuleVersions", fields: [createdById], references: [id])

  module      Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([moduleId, version])
  @@index([moduleId])
  @@map("module_versions")
}

model LessonVersion {
  id          String   @id @default(cuid())
  lessonId    String
  version     Int

  // Snapshot of lesson data
  title       String
  description String?
  type        String
  orderIndex  Int
  duration    Int?
  content     String?
  contentBlocks Json?
  videoUrl    String?
  videoProvider String?
  videoDuration Int?
  attachments String[]
  isPreview   Boolean
  isMandatory Boolean
  pointsReward Int

  // Metadata
  changeDescription String?
  createdById       String
  createdBy         User     @relation("LessonVersions", fields: [createdById], references: [id])

  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([lessonId, version])
  @@index([lessonId])
  @@map("lesson_versions")
}

// ============================================
// INTERACTIVE VIDEO QUIZZES
// ============================================

model VideoQuiz {
  id          String   @id @default(cuid())
  lessonId    String

  // Quiz timing
  timestamp   Int      // When to show quiz (in seconds from video start)

  // Question content
  question    String
  options     String[] // Array of possible answers
  correctAnswer Int    // Index of correct answer (0-based)
  explanation String?  // Optional explanation shown after answering

  // Settings
  points      Int      @default(10)
  isRequired  Boolean  @default(false) // Must answer to continue video
  pauseVideo  Boolean  @default(true)  // Pause video when quiz appears

  // Relations
  lesson      Lesson             @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  responses   VideoQuizResponse[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([lessonId])
  @@index([timestamp])
  @@map("video_quizzes")
}

model VideoQuizResponse {
  id          String   @id @default(cuid())
  userId      String
  videoQuizId String

  // Response data
  answer      Int      // Selected answer index
  isCorrect   Boolean
  timeSpent   Int?     // Seconds taken to answer

  // Relations
  user        User      @relation("VideoQuizResponses", fields: [userId], references: [id], onDelete: Cascade)
  videoQuiz   VideoQuiz @relation(fields: [videoQuizId], references: [id], onDelete: Cascade)

  answeredAt  DateTime @default(now())

  @@unique([userId, videoQuizId])
  @@index([userId])
  @@index([videoQuizId])
  @@map("video_quiz_responses")
}

// ============================================
// FLASHCARDS SYSTEM
// ============================================

model FlashcardDeck {
  id          String   @id @default(cuid())

  // Basic info
  title       String
  description String?

  // Association
  courseId    String?
  lessonId    String?
  createdById String

  // Settings
  isPublic    Boolean  @default(false)
  tags        String[]

  // Relations
  course      Course?    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson      Lesson?    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  createdBy   User       @relation("FlashcardDecksCreated", fields: [createdById], references: [id])
  flashcards  Flashcard[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([courseId])
  @@index([lessonId])
  @@index([createdById])
  @@map("flashcard_decks")
}

model Flashcard {
  id          String   @id @default(cuid())
  deckId      String

  // Card content
  front       String   // Question or term
  back        String   // Answer or definition
  hint        String?  // Optional hint
  image       String?  // Optional image URL

  // Ordering
  orderIndex  Int

  // Relations
  deck        FlashcardDeck     @relation(fields: [deckId], references: [id], onDelete: Cascade)
  reviews     FlashcardReview[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([deckId])
  @@map("flashcards")
}

enum ReviewDifficulty {
  AGAIN     // Didn't remember
  HARD      // Remembered with difficulty
  GOOD      // Remembered correctly
  EASY      // Remembered easily
}

model FlashcardReview {
  id          String           @id @default(cuid())
  userId      String
  flashcardId String

  // Review data
  difficulty  ReviewDifficulty
  timeSpent   Int?             // Seconds spent on card

  // Spaced Repetition Algorithm (SM-2)
  easeFactor  Float            // Ease factor (>=1.3)
  interval    Int              // Days until next review
  repetitions Int              // Number of successful reviews

  // Next review date
  nextReview  DateTime

  // Relations
  user        User      @relation("FlashcardReviews", fields: [userId], references: [id], onDelete: Cascade)
  flashcard   Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)

  reviewedAt  DateTime @default(now())

  @@index([userId])
  @@index([flashcardId])
  @@index([nextReview])
  @@index([userId, nextReview])
  @@map("flashcard_reviews")
}

// ============================================
// STUDY GROUPS
// ============================================

enum StudyGroupRole {
  ADMIN     // Can manage group, invite members, delete
  MODERATOR // Can manage content and members
  MEMBER    // Regular member
}

model StudyGroup {
  id          String   @id @default(cuid())

  // Basic info
  name        String
  description String?
  avatar      String?  // Group avatar URL

  // Settings
  isPrivate   Boolean  @default(true)
  maxMembers  Int      @default(50)

  // Association with course (optional)
  courseId    String?

  // Relations
  course      Course?           @relation(fields: [courseId], references: [id], onDelete: SetNull)
  members     StudyGroupMember[]
  messages    StudyGroupMessage[]
  resources   StudyGroupResource[]
  sessions    StudySession[]
  invites     StudyGroupInvite[]

  createdById String
  createdBy   User     @relation("StudyGroupsCreated", fields: [createdById], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([courseId])
  @@index([createdById])
  @@map("study_groups")
}

model StudyGroupMember {
  id          String         @id @default(cuid())
  groupId     String
  userId      String

  role        StudyGroupRole @default(MEMBER)

  // Relations
  group       StudyGroup     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user        User           @relation("StudyGroupMemberships", fields: [userId], references: [id], onDelete: Cascade)

  joinedAt    DateTime       @default(now())

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("study_group_members")
}

model StudyGroupMessage {
  id          String     @id @default(cuid())
  groupId     String
  userId      String

  content     String
  attachments String[]   // File URLs

  // Reply support
  replyToId   String?
  replyTo     StudyGroupMessage?  @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies     StudyGroupMessage[] @relation("MessageReplies")

  // Relations
  group       StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user        User       @relation("StudyGroupMessages", fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([groupId])
  @@index([userId])
  @@map("study_group_messages")
}

model StudyGroupResource {
  id          String     @id @default(cuid())
  groupId     String
  userId      String

  // Resource info
  title       String
  description String?
  type        String     // 'file', 'link', 'note'
  url         String?    // File URL or external link
  content     String?    // For notes

  // Relations
  group       StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user        User       @relation("StudyGroupResources", fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([groupId])
  @@index([userId])
  @@map("study_group_resources")
}

model StudySession {
  id          String     @id @default(cuid())
  groupId     String

  // Session info
  title       String
  description String?
  scheduledAt DateTime
  duration    Int        // Minutes
  meetingUrl  String?    // Video call link

  // Relations
  group       StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdById String
  createdBy   User       @relation("StudySessionsCreated", fields: [createdById], references: [id])

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([groupId])
  @@index([scheduledAt])
  @@map("study_sessions")
}

model StudyGroupInvite {
  id          String     @id @default(cuid())
  groupId     String
  invitedById String

  // Invite details
  email       String?    // Email to invite
  token       String     @unique // Unique invite token
  expiresAt   DateTime

  // Status
  usedAt      DateTime?
  usedById    String?

  // Relations
  group       StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  invitedBy   User       @relation("StudyGroupInvitesSent", fields: [invitedById], references: [id])

  createdAt   DateTime   @default(now())

  @@index([groupId])
  @@index([token])
  @@map("study_group_invites")
}

// ============================================
// LEARNING STREAKS & DAILY GOALS
// ============================================

model LearningStreak {
  id            String   @id @default(cuid())
  userId        String   @unique

  // Current streak
  currentStreak Int      @default(0)
  longestStreak Int      @default(0)
  lastActivityDate DateTime?

  // Daily goals
  dailyGoalMinutes Int   @default(15) // Default 15 minutes per day
  dailyGoalLessons Int   @default(1)  // Default 1 lesson per day

  // Streak protection
  freezeDaysAvailable Int @default(0) // Days you can miss without losing streak
  freezeDaysUsed      Int @default(0)

  // Statistics
  totalDaysActive     Int @default(0)
  totalMinutesLearned Int @default(0)
  totalLessonsCompleted Int @default(0)

  // Achievements
  streakMilestones    Int[] @default([]) // Achieved milestones: 7, 30, 100, 365 days

  // Relations
  user          User     @relation("UserLearningStreak", fields: [userId], references: [id], onDelete: Cascade)
  dailyActivities DailyActivity[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([currentStreak])
  @@map("learning_streaks")
}

model DailyActivity {
  id            String   @id @default(cuid())
  streakId      String
  date          DateTime @db.Date // Just the date, no time

  // Activity metrics
  minutesLearned Int     @default(0)
  lessonsCompleted Int   @default(0)
  quizzesCompleted Int   @default(0)
  pointsEarned   Int     @default(0)

  // Goal completion
  goalMet       Boolean  @default(false)
  usedFreeze    Boolean  @default(false)

  // Activity breakdown
  courseActivities Json? // { courseId: { minutes: number, lessons: number } }

  // Relations
  streak        LearningStreak @relation(fields: [streakId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([streakId, date])
  @@index([streakId])
  @@index([date])
  @@map("daily_activities")
}

model StreakReward {
  id            String   @id @default(cuid())
  userId        String

  // Reward info
  milestone     Int      // 7, 30, 100, 365, etc.
  rewardType    String   // 'badge', 'points', 'freeze_day', 'discount'
  rewardValue   String   // Badge ID, points amount, etc.
  claimedAt     DateTime?

  // Relations
  user          User     @relation("UserStreakRewards", fields: [userId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())

  @@unique([userId, milestone])
  @@index([userId])
  @@map("streak_rewards")
}

// ============================================
// PEER REVIEW & ASSIGNMENTS
// ============================================

enum AssignmentType {
  ESSAY
  PROJECT
  CODE
  PRESENTATION
  RESEARCH
  CASE_STUDY
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  CLOSED
  GRADING
  COMPLETED
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  REVIEWED
  NEEDS_REVISION
  APPROVED
}

model Assignment {
  id              String           @id @default(cuid())
  courseId        String
  lessonId        String?
  instructorId    String

  title           String
  description     String
  instructions    String?
  type            AssignmentType   @default(PROJECT)
  status          AssignmentStatus @default(DRAFT)

  // Deadlines
  dueDate         DateTime?
  reviewDueDate   DateTime?

  // Settings
  maxPoints       Int              @default(100)
  minWordCount    Int?
  maxWordCount    Int?
  allowedFileTypes String[]        @default(["pdf", "doc", "docx"])
  maxFileSize     Int              @default(10) // MB

  // Peer Review Settings
  peerReviewEnabled Boolean        @default(true)
  reviewsRequired   Int            @default(3) // Number of reviews each submission needs
  reviewsPerStudent Int            @default(3) // Number of reviews each student must do
  anonymousReviews  Boolean        @default(true)
  allowSelfReview   Boolean        @default(false)

  // Relations
  course          Course           @relation("CourseAssignments", fields: [courseId], references: [id], onDelete: Cascade)
  lesson          Lesson?          @relation("LessonAssignments", fields: [lessonId], references: [id], onDelete: SetNull)
  instructor      User             @relation("InstructorAssignments", fields: [instructorId], references: [id])
  submissions     AssignmentSubmission[]
  criteria        PeerReviewCriteria[]

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([courseId])
  @@index([instructorId])
  @@index([status])
  @@map("assignments")
}

model PeerReviewCriteria {
  id              String       @id @default(cuid())
  assignmentId    String

  name            String
  description     String?
  maxScore        Int          @default(10)
  weight          Float        @default(1.0) // Weight for final score calculation
  orderIndex      Int          @default(0)

  // Relations
  assignment      Assignment   @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  scores          PeerReviewScore[]

  createdAt       DateTime     @default(now())

  @@index([assignmentId])
  @@map("peer_review_criteria")
}

model AssignmentSubmission {
  id              String           @id @default(cuid())
  assignmentId    String
  studentId       String

  // Content
  content         String?          // Text content
  fileUrl         String?          // Uploaded file
  fileName        String?
  fileSize        Int?             // bytes

  status          SubmissionStatus @default(DRAFT)

  // Scoring
  selfAssessment  String?          // Optional student self-reflection
  instructorScore Float?           // Score given by instructor
  peerScore       Float?           // Average score from peer reviews
  finalScore      Float?           // Final calculated score
  instructorFeedback String?

  // Timestamps
  submittedAt     DateTime?
  reviewedAt      DateTime?

  // Relations
  assignment      Assignment       @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student         User             @relation("StudentSubmissions", fields: [studentId], references: [id])
  receivedReviews PeerReview[]     @relation("SubmissionReviews")

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@index([status])
  @@map("assignment_submissions")
}

model PeerReview {
  id              String              @id @default(cuid())
  submissionId    String
  reviewerId      String

  // Review content
  overallFeedback String?
  strengthsNote   String?
  improvementsNote String?

  // Scoring
  totalScore      Float?              // Calculated from criteria scores
  isCompleted     Boolean             @default(false)

  // Quality metrics (for reviewer)
  helpfulnessRating Int?              // 1-5, rated by submission author
  instructorQualityScore Float?       // Instructor can rate review quality

  // Relations
  submission      AssignmentSubmission @relation("SubmissionReviews", fields: [submissionId], references: [id], onDelete: Cascade)
  reviewer        User                 @relation("ReviewerReviews", fields: [reviewerId], references: [id])
  criteriaScores  PeerReviewScore[]

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  completedAt     DateTime?

  @@unique([submissionId, reviewerId])
  @@index([submissionId])
  @@index([reviewerId])
  @@map("peer_reviews")
}

model PeerReviewScore {
  id              String             @id @default(cuid())
  reviewId        String
  criteriaId      String

  score           Int
  feedback        String?

  // Relations
  review          PeerReview         @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  criteria        PeerReviewCriteria @relation(fields: [criteriaId], references: [id], onDelete: Cascade)

  createdAt       DateTime           @default(now())

  @@unique([reviewId, criteriaId])
  @@index([reviewId])
  @@map("peer_review_scores")
}

// ============================================
// COURSE BUNDLES & PROMO CODES
// ============================================

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum PromoCodeStatus {
  ACTIVE
  EXPIRED
  DISABLED
}

model CourseBundle {
  id              String         @id @default(cuid())
  name            String
  slug            String         @unique
  description     String?
  thumbnail       String?

  // Pricing
  originalPrice   Decimal        @db.Decimal(10, 2) // Sum of individual course prices
  discountedPrice Decimal        @db.Decimal(10, 2) // Bundle price
  savingsPercent  Float          @default(0) // Calculated savings percentage

  // Settings
  isPublished     Boolean        @default(false)
  isLimited       Boolean        @default(false) // Limited time offer
  startDate       DateTime?
  endDate         DateTime?
  maxPurchases    Int?           // Maximum number of purchases allowed

  // Stats
  purchaseCount   Int            @default(0)

  // Relations
  courses         BundleCourse[]
  payments        Payment[]      @relation("BundlePayments")

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([slug])
  @@index([isPublished])
  @@map("course_bundles")
}

model BundleCourse {
  id              String       @id @default(cuid())
  bundleId        String
  courseId        String
  orderIndex      Int          @default(0)

  // Relations
  bundle          CourseBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  course          Course       @relation("BundleCourses", fields: [courseId], references: [id], onDelete: Cascade)

  createdAt       DateTime     @default(now())

  @@unique([bundleId, courseId])
  @@index([bundleId])
  @@index([courseId])
  @@map("bundle_courses")
}

model PromoCode {
  id              String          @id @default(cuid())
  code            String          @unique
  description     String?

  // Discount settings
  discountType    DiscountType    @default(PERCENTAGE)
  discountValue   Decimal         @db.Decimal(10, 2) // Percentage (0-100) or fixed amount
  minPurchase     Decimal?        @db.Decimal(10, 2) // Minimum purchase amount to apply
  maxDiscount     Decimal?        @db.Decimal(10, 2) // Maximum discount cap for percentage

  // Validity
  status          PromoCodeStatus @default(ACTIVE)
  startDate       DateTime        @default(now())
  endDate         DateTime?

  // Usage limits
  usageLimit      Int?            // Total uses allowed (null = unlimited)
  perUserLimit    Int             @default(1) // Uses per user
  usageCount      Int             @default(0) // Current usage count

  // Restrictions
  courseIds       String[]        @default([]) // Empty = applies to all courses
  bundleIds       String[]        @default([]) // Empty = applies to all bundles
  userIds         String[]        @default([]) // Empty = available to all users
  newUsersOnly    Boolean         @default(false) // Only for first-time buyers

  // Relations
  usages          PromoCodeUsage[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([code])
  @@index([status])
  @@map("promo_codes")
}

model PromoCodeUsage {
  id              String    @id @default(cuid())
  promoCodeId     String
  userId          String
  paymentId       String?

  // Applied discount
  discountAmount  Decimal   @db.Decimal(10, 2)
  originalAmount  Decimal   @db.Decimal(10, 2)
  finalAmount     Decimal   @db.Decimal(10, 2)

  // Relations
  promoCode       PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)
  user            User      @relation("UserPromoUsages", fields: [userId], references: [id])
  payment         Payment?  @relation("PaymentPromoUsage", fields: [paymentId], references: [id])

  usedAt          DateTime  @default(now())

  @@index([promoCodeId])
  @@index([userId])
  @@map("promo_code_usages")
}
