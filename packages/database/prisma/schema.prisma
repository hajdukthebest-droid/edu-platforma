// Prisma Schema za Edu Platforma
// Database: PostgreSQL 16+

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

// ============================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  INSTRUCTOR
  LEARNER
  MANAGER
  PHARMACIST
  PHARMACY_TECHNICIAN
  MEDICAL_REP
  CLINICAL_RESEARCHER
  REGULATOR
}

enum LearningStyle {
  VISUAL
  AUDITORY
  KINESTHETIC
  READING_WRITING
}

enum LearningPace {
  SLOW
  MODERATE
  FAST
}

model User {
  id                String         @id @default(cuid())
  email             String         @unique
  emailVerified     DateTime?
  username          String?        @unique
  password          String?
  firstName         String?
  lastName          String?
  avatar            String?
  bio               String?
  phone             String?
  dateOfBirth       DateTime?
  role              UserRole       @default(LEARNER)

  // Professional info
  profession        String?
  licenseNumber     String?
  organization      String?
  department        String?
  jobTitle          String?

  // Learning preferences
  learningStyle     LearningStyle?
  learningPace      LearningPace?
  preferredLanguage String         @default("hr")
  timezone          String         @default("Europe/Zagreb")
  preferredDomains  String[]       @default([]) // User's preferred learning domains

  // Gamification
  totalPoints       Int            @default(0)
  level             Int            @default(1)
  currentStreak     Int            @default(0)
  longestStreak     Int            @default(0)
  lastActivityDate  DateTime?

  // Settings
  emailNotifications Boolean       @default(true)
  pushNotifications  Boolean       @default(true)
  marketingEmails    Boolean       @default(false)
  isActive          Boolean        @default(true)
  isVerified        Boolean        @default(false)

  // Timestamps
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  lastLoginAt       DateTime?

  // Relations
  accounts          Account[]
  sessions          Session[]
  enrollments       Enrollment[]
  courseProgress    CourseProgress[]
  lessonProgress    LessonProgress[]
  assessmentAttempts AssessmentAttempt[]
  certificates      Certificate[]
  badges            UserBadge[]
  achievements      UserAchievement[]
  forumPosts        ForumPost[]
  forumComments     ForumComment[]
  forumVotes        ForumVote[]
  reviews           Review[]
  notes             Note[]
  bookmarks         Bookmark[]
  notifications     Notification[]
  createdCourses    Course[]       @relation("CourseCreator")
  payments          Payment[]
  subscriptions     Subscription[]
  learningPathsCreated LearningPath[] @relation("LearningPathsCreated")
  userLearningPaths UserLearningPath[]
  conversationsAsParticipant1 Conversation[] @relation("ConversationsAsParticipant1")
  conversationsAsParticipant2 Conversation[] @relation("ConversationsAsParticipant2")
  messagesSent      Message[]      @relation("MessagesSent")
  instructorSessions LiveSession[] @relation("InstructorSessions")
  sessionAttendance LiveSessionAttendance[]
  sessionMessages   LiveSessionMessage[]
  courseVersions    CourseVersion[] @relation("CourseVersions")
  moduleVersions    ModuleVersion[] @relation("ModuleVersions")
  lessonVersions    LessonVersion[] @relation("LessonVersions")
  videoQuizResponses VideoQuizResponse[] @relation("VideoQuizResponses")
  flashcardDecks    FlashcardDeck[] @relation("FlashcardDecksCreated")
  flashcardReviews  FlashcardReview[] @relation("FlashcardReviews")
  examSessions      ExamSession[] @relation("ExamSessions")
  studyGroupsCreated StudyGroup[] @relation("StudyGroupsCreated")
  studyGroupMemberships StudyGroupMember[] @relation("StudyGroupMemberships")
  studyGroupMessages StudyGroupMessage[] @relation("StudyGroupMessages")
  studyGroupResources StudyGroupResource[] @relation("StudyGroupResources")
  studySessionsCreated StudySession[] @relation("StudySessionsCreated")
  studyGroupInvitesSent StudyGroupInvite[] @relation("StudyGroupInvitesSent")
  learningStreak    LearningStreak? @relation("UserLearningStreak")
  streakRewards     StreakReward[] @relation("UserStreakRewards")
  tutorProfile      TutorProfile? @relation("TutorProfile")
  tutoringRequests  TutoringRequest[] @relation("StudentTutoringRequests")
  tutoringSessions  TutoringSession[] @relation("StudentSessions")
  tutoringReviews   TutoringReview[] @relation("StudentTutoringReviews")
  challengeParticipations ChallengeParticipant[] @relation("UserChallenges")
  challengeLeaderboards ChallengeLeaderboard[] @relation("UserChallengeLeaderboard")
  teamMemberships   TeamMember[] @relation("UserTeamMemberships")
  followers         UserFollow[] @relation("UserFollowing")
  following         UserFollow[] @relation("UserFollowers")
  activities        Activity[] @relation("UserActivities")
  activityLikes     ActivityLike[] @relation("UserActivityLikes")
  activityComments  ActivityComment[] @relation("UserActivityComments")
  socialProfile     UserProfile? @relation("UserSocialProfile")
  notificationPrefs NotificationPreferences? @relation("UserNotificationPrefs")
  pushSubscriptions PushSubscription[] @relation("UserPushSubscriptions")
  scheduledReminders ScheduledReminder[] @relation("UserScheduledReminders")
  notificationLogs  NotificationLog[] @relation("UserNotificationLogs")
  emailDigests      EmailDigestQueue[] @relation("UserEmailDigests")

  @@index([email])
  @@index([role])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// COURSE MANAGEMENT
// ============================================

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Domain represents main industry/field (IT, Healthcare, Business, etc.)
model Domain {
  id          String     @id @default(cuid())
  name        String     @unique
  slug        String     @unique
  description String?
  icon        String?    // Icon/emoji for the domain
  color       String?    // Brand color for the domain
  coverImage  String?    // Cover image for domain landing page
  order       Int        @default(0) // Display order
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  categories  Category[]

  @@map("domains")
}

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  icon        String?
  domainId    String?    // Link to parent domain
  domain      Domain?    @relation(fields: [domainId], references: [id], onDelete: SetNull)
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  courses     Course[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([domainId])
  @@map("categories")
}

model Course {
  id                String        @id @default(cuid())
  title             String
  slug              String        @unique
  description       String?
  shortDescription  String?
  thumbnail         String?
  coverImage        String?

  // Course details
  level             CourseLevel   @default(BEGINNER)
  status            CourseStatus  @default(DRAFT)
  language          String        @default("hr")
  duration          Int?          // minutes
  price             Decimal       @default(0) @db.Decimal(10, 2)

  // Metadata
  tags              String[]
  learningObjectives String[]
  requirements      String[]
  targetAudience    String?

  // Gamification
  pointsReward      Int           @default(100)

  // CPD/CME
  cpdPoints         Float?
  cmeCredits        Float?
  accreditedBy      String?

  // Stats
  enrollmentCount   Int           @default(0)
  completionCount   Int           @default(0)
  averageRating     Float?
  totalReviews      Int           @default(0)
  viewCount         Int           @default(0)

  // Relations
  creatorId         String
  creator           User          @relation("CourseCreator", fields: [creatorId], references: [id])
  categoryId        String?
  category          Category?     @relation(fields: [categoryId], references: [id])

  modules           Module[]
  enrollments       Enrollment[]
  progress          CourseProgress[]
  reviews           Review[]
  certificates      Certificate[]
  learningPaths     LearningPathCourse[]
  translations      CourseTranslation[]
  versions          CourseVersion[]
  flashcardDecks    FlashcardDeck[]
  studyGroups       StudyGroup[]

  // Timestamps
  publishedAt       DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([slug])
  @@index([status])
  @@index([creatorId])
  @@map("courses")
}

model Module {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String?
  orderIndex  Int
  duration    Int?     // minutes

  course       Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons      Lesson[]
  translations ModuleTranslation[]
  versions     ModuleVersion[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([courseId, orderIndex])
  @@map("modules")
}

enum LessonType {
  VIDEO
  ARTICLE
  QUIZ
  ASSIGNMENT
  LIVE_SESSION
  INTERACTIVE
  SCORM
  DOCUMENT
}

model Lesson {
  id          String     @id @default(cuid())
  moduleId    String
  title       String
  description String?
  type        LessonType
  orderIndex  Int
  duration    Int?       // minutes

  // Content
  content     String?    // Rich text for articles
  contentBlocks Json?    // Flexible content blocks (code, quiz, interactive)
  videoUrl    String?
  videoProvider String?  // 'youtube', 'vimeo', 'mux', 'self-hosted'
  videoDuration Int?
  attachments String[]   // File URLs

  // Template & Builder
  templateId  String?    // Reference to content template used
  isDraft     Boolean    @default(true)

  // Settings
  isPreview   Boolean    @default(false)
  isMandatory Boolean    @default(true)
  pointsReward Int       @default(20)

  module       Module              @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress     LessonProgress[]
  notes        Note[]
  bookmarks    Bookmark[]
  translations LessonTranslation[]
  versions     LessonVersion[]
  videoQuizzes VideoQuiz[]
  flashcardDecks FlashcardDeck[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@unique([moduleId, orderIndex])
  @@map("lessons")
}

// Content Templates for Course Builder
enum TemplateCategory {
  INTRODUCTION
  THEORY
  PRACTICAL
  ASSESSMENT
  DISCUSSION
  PROJECT
}

model ContentTemplate {
  id          String            @id @default(cuid())
  name        String
  description String?
  category    TemplateCategory
  lessonType  LessonType

  // Template structure
  contentStructure Json          // JSON structure for content blocks
  thumbnail   String?

  // Usage tracking
  usageCount  Int               @default(0)
  isPublic    Boolean           @default(true)
  createdById String?

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([category])
  @@index([lessonType])
  @@map("content_templates")
}

// ============================================
// ASSESSMENTS & QUIZZES
// ============================================

enum AssessmentType {
  QUIZ
  EXAM
  ASSIGNMENT
  SURVEY
  PRACTICE
}

model Assessment {
  id              String         @id @default(cuid())
  courseId        String?
  lessonId        String?        // Link to lesson for in-lesson quizzes
  moduleId        String?        // Link to module for module-end quizzes
  title           String
  description     String?
  type            AssessmentType @default(QUIZ)

  // Settings
  timeLimit       Int?           // minutes
  passingScore    Int            @default(70) // percentage
  maxAttempts     Int?           // null = unlimited
  shuffleQuestions Boolean       @default(false)
  shuffleAnswers  Boolean        @default(false)
  showResults     Boolean        @default(true)
  showCorrectAnswers Boolean     @default(true)

  // Advanced settings
  requiresManualGrading Boolean  @default(false) // If contains essay questions
  isPublished     Boolean        @default(false)
  randomizeQuestions Int?        // Number of random questions to show (null = all)

  // Timed Exam Settings
  isTimedExam     Boolean        @default(false) // Enable strict timing
  autoSubmit      Boolean        @default(true)  // Auto-submit when time expires
  showTimer       Boolean        @default(true)  // Display countdown timer
  allowPause      Boolean        @default(false) // Allow pausing exam
  proctorMode     Boolean        @default(false) // Enable proctoring features
  requireFullscreen Boolean      @default(false) // Must be in fullscreen
  preventCopyPaste Boolean       @default(false) // Block copy/paste
  showOneQuestion Boolean        @default(false) // Show one question at a time
  allowBackNavigation Boolean    @default(true)  // Can go back to previous questions

  // Timing
  availableFrom   DateTime?      // When quiz becomes available
  availableUntil  DateTime?      // When quiz expires

  // Gamification
  pointsReward    Int            @default(50)

  questions       Question[]
  attempts        AssessmentAttempt[]
  examSessions    ExamSession[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@map("assessments")
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
  FILL_BLANK
  MATCHING
  ORDERING
}

model Question {
  id              String       @id @default(cuid())
  assessmentId    String
  type            QuestionType
  question        String
  explanation     String?
  points          Int          @default(1)
  orderIndex      Int

  // For multiple choice
  options         Json?        // Array of options
  correctAnswers  Json?        // Array of correct answer indices

  assessment      Assessment   @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("questions")
}

enum GradingStatus {
  NOT_GRADED
  PENDING
  GRADED
  NEEDS_REVISION
}

model AssessmentAttempt {
  id            String        @id @default(cuid())
  assessmentId  String
  userId        String

  answers       Json          // User's answers per question
  score         Float
  totalPoints   Int
  earnedPoints  Int
  passed        Boolean
  timeSpent     Int?          // seconds

  // Manual grading support
  gradingStatus GradingStatus @default(NOT_GRADED)
  gradedBy      String?       // Instructor ID who graded
  gradedAt      DateTime?
  feedback      String?       // Overall feedback from instructor

  // Timed Exam Tracking
  remainingTime Int?          // seconds remaining (for paused exams)
  pausedAt      DateTime?     // When exam was paused
  pauseCount    Int           @default(0) // Number of times paused
  warningsIssued Json?        // Array of proctoring warnings

  startedAt     DateTime      @default(now())
  completedAt   DateTime?

  assessment    Assessment    @relation(fields: [assessmentId], references: [id])
  user          User          @relation(fields: [userId], references: [id])
  questionAttempts QuestionAttempt[]

  @@map("assessment_attempts")
}

// Detailed tracking of individual question attempts
model QuestionAttempt {
  id              String            @id @default(cuid())
  attemptId       String
  questionId      String

  answer          Json              // User's answer
  isCorrect       Boolean?          // null for ungraded
  pointsEarned    Float             @default(0)

  // Manual grading
  instructorFeedback String?

  attempt         AssessmentAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  createdAt       DateTime          @default(now())

  @@map("question_attempts")
}

enum ExamSessionStatus {
  ACTIVE        // Exam in progress
  PAUSED        // Exam paused
  COMPLETED     // Exam finished
  EXPIRED       // Time ran out
  ABANDONED     // User left without finishing
}

// Real-time tracking of active exam sessions
model ExamSession {
  id            String            @id @default(cuid())
  assessmentId  String
  attemptId     String?           // Link to attempt when created
  userId        String

  status        ExamSessionStatus @default(ACTIVE)

  // Time tracking
  timeLimit     Int               // Total time in seconds
  timeRemaining Int               // Seconds remaining
  timeElapsed   Int               @default(0) // Total time spent

  // Session data
  currentQuestion Int?            // Current question index (for one-at-a-time mode)
  answers       Json?             // Temporary answers storage

  // Proctoring data
  fullscreenExits Int             @default(0) // Number of fullscreen exits
  tabSwitches   Int               @default(0) // Number of tab switches
  suspiciousActivity Json?        // Array of suspicious events

  // Timestamps
  startedAt     DateTime          @default(now())
  lastActivity  DateTime          @default(now()) // Last action timestamp
  pausedAt      DateTime?
  completedAt   DateTime?
  expiresAt     DateTime          // When session will auto-expire

  // Relations
  assessment    Assessment        @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  user          User              @relation("ExamSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([assessmentId])
  @@index([status])
  @@map("exam_sessions")
}

// ============================================
// PROGRESS TRACKING
// ============================================

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  DROPPED
  EXPIRED
}

model Enrollment {
  id              String           @id @default(cuid())
  userId          String
  courseId        String
  status          EnrollmentStatus @default(ACTIVE)

  startedAt       DateTime         @default(now())
  completedAt     DateTime?
  lastAccessedAt  DateTime?
  expiresAt       DateTime?

  user            User             @relation(fields: [userId], references: [id])
  course          Course           @relation(fields: [courseId], references: [id])

  @@unique([userId, courseId])
  @@map("enrollments")
}

model CourseProgress {
  id                String   @id @default(cuid())
  userId            String
  courseId          String

  completedLessons  Int      @default(0)
  totalLessons      Int
  progressPercentage Float   @default(0)

  totalTimeSpent    Int      @default(0) // seconds
  lastAccessedAt    DateTime?

  user              User     @relation(fields: [userId], references: [id])
  course            Course   @relation(fields: [courseId], references: [id])

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([userId, courseId])
  @@map("course_progress")
}

model LessonProgress {
  id            String   @id @default(cuid())
  userId        String
  lessonId      String

  isCompleted   Boolean  @default(false)
  completedAt   DateTime?
  timeSpent     Int      @default(0) // seconds
  lastPosition  Int?     // for video position

  user          User     @relation(fields: [userId], references: [id])
  lesson        Lesson   @relation(fields: [lessonId], references: [id])

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, lessonId])
  @@map("lesson_progress")
}

// ============================================
// CERTIFICATES
// ============================================

model Certificate {
  id              String   @id @default(cuid())
  userId          String
  courseId        String

  certificateNumber String @unique
  title           String
  description     String?

  issueDate       DateTime @default(now())
  expiryDate      DateTime?

  pdfUrl          String?
  blockchainHash  String?  // For blockchain verification

  // Verification
  verificationUrl String?
  qrCode          String?

  user            User     @relation(fields: [userId], references: [id])
  course          Course   @relation(fields: [courseId], references: [id])

  createdAt       DateTime @default(now())

  @@index([certificateNumber])
  @@map("certificates")
}

// ============================================
// GAMIFICATION
// ============================================

enum BadgeType {
  COMPLETION
  SKILL
  SOCIAL
  STREAK
  SPECIAL
}

model Badge {
  id          String    @id @default(cuid())
  name        String
  description String
  icon        String
  type        BadgeType
  criteria    Json      // Criteria to earn the badge
  pointsValue Int       @default(0)

  userBadges  UserBadge[]

  createdAt   DateTime  @default(now())

  @@map("badges")
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String

  earnedAt  DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  badge     Badge    @relation(fields: [badgeId], references: [id])

  @@unique([userId, badgeId])
  @@map("user_badges")
}

model Achievement {
  id          String   @id @default(cuid())
  name        String
  description String
  icon        String
  points      Int      @default(0)
  criteria    Json

  userAchievements UserAchievement[]

  createdAt   DateTime @default(now())

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String

  progress      Int         @default(0)
  isCompleted   Boolean     @default(false)
  completedAt   DateTime?

  user          User        @relation(fields: [userId], references: [id])
  achievement   Achievement @relation(fields: [achievementId], references: [id])

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

// ============================================
// SOCIAL LEARNING
// ============================================

model ForumCategory {
  id          String      @id @default(cuid())
  name        String
  description String?
  orderIndex  Int

  posts       ForumPost[]

  createdAt   DateTime    @default(now())

  @@map("forum_categories")
}

model ForumPost {
  id          String        @id @default(cuid())
  categoryId  String
  authorId    String

  // Q&A Context
  courseId    String?       // Link to course for course discussions
  lessonId    String?       // Link to lesson for lesson-specific questions

  title       String
  content     String
  tags        String[]      @default([]) // Tags for better organization

  isPinned    Boolean       @default(false)
  isLocked    Boolean       @default(false)

  // Q&A Features
  isSolved    Boolean       @default(false) // Has an accepted answer
  bestAnswerId String?      // The comment marked as best answer

  viewCount   Int           @default(0)
  upvotes     Int           @default(0)
  downvotes   Int           @default(0)

  category    ForumCategory @relation(fields: [categoryId], references: [id])
  author      User          @relation(fields: [authorId], references: [id])
  comments    ForumComment[]
  votes       ForumVote[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([courseId])
  @@index([lessonId])
  @@index([isSolved])
  @@map("forum_posts")
}

model ForumComment {
  id          String   @id @default(cuid())
  postId      String
  authorId    String

  // Threading support
  parentCommentId String? // For nested replies
  parentComment   ForumComment?  @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies         ForumComment[] @relation("CommentReplies")

  content     String
  upvotes     Int      @default(0)
  downvotes   Int      @default(0)

  // Q&A Features
  isBestAnswer Boolean @default(false) // Marked as best answer by post author

  post        ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  author      User      @relation(fields: [authorId], references: [id])
  votes       ForumVote[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([postId])
  @@index([parentCommentId])
  @@map("forum_comments")
}

enum VoteType {
  UP
  DOWN
}

model ForumVote {
  id        String   @id @default(cuid())
  userId    String

  // Either postId or commentId will be set
  postId    String?
  commentId String?

  voteType  VoteType

  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      ForumPost?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment   ForumComment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Prevent duplicate votes - user can only vote once per post or comment
  @@unique([userId, postId])
  @@unique([userId, commentId])
  @@index([userId])
  @@index([postId])
  @@index([commentId])
  @@map("forum_votes")
}

model Review {
  id        String   @id @default(cuid())
  courseId  String
  userId    String

  rating    Int      // 1-5
  comment   String?

  course    Course   @relation(fields: [courseId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courseId, userId])
  @@map("reviews")
}

model Note {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String

  content   String
  timestamp Int?     // Video timestamp if applicable

  user      User     @relation(fields: [userId], references: [id])
  lesson    Lesson   @relation(fields: [lessonId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notes")
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  lessonId  String

  user      User     @relation(fields: [userId], references: [id])
  lesson    Lesson   @relation(fields: [lessonId], references: [id])

  createdAt DateTime @default(now())

  @@unique([userId, lessonId])
  @@map("bookmarks")
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  COURSE_UPDATE
  NEW_CONTENT
  ACHIEVEMENT
  BADGE
  CERTIFICATE
  REMINDER
  SOCIAL
  SYSTEM
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType

  title     String
  message   String
  link      String?

  isRead    Boolean          @default(false)
  readAt    DateTime?

  user      User             @relation(fields: [userId], references: [id])

  createdAt DateTime         @default(now())

  @@map("notifications")
}

// ============================================
// PAYMENTS & SUBSCRIPTIONS
// ============================================

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Payment {
  id              String        @id @default(cuid())
  userId          String

  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("EUR")
  status          PaymentStatus @default(PENDING)

  stripePaymentId String?
  paymentMethod   String?

  // What was purchased
  courseId        String?
  subscriptionId  String?

  user            User          @relation(fields: [userId], references: [id])

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("payments")
}

enum SubscriptionPlan {
  FREE
  BASIC
  PRO
  TEAM
  BUSINESS
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
}

model Subscription {
  id                String             @id @default(cuid())
  userId            String

  plan              SubscriptionPlan
  status            SubscriptionStatus @default(ACTIVE)

  stripeSubscriptionId String?
  stripePriceId     String?

  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean           @default(false)
  cancelledAt        DateTime?

  user              User               @relation(fields: [userId], references: [id])

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@map("subscriptions")
}

// ============================================
// LEARNING PATHS
// ============================================

model LearningPath {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  description String?
  thumbnail   String?

  level       CourseLevel?
  estimatedHours Int?

  isPublished Boolean  @default(false)
  creatorId   String

  creator     User     @relation("LearningPathsCreated", fields: [creatorId], references: [id])
  courses     LearningPathCourse[]
  userPaths   UserLearningPath[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("learning_paths")
}

model LearningPathCourse {
  id              String       @id @default(cuid())
  learningPathId  String
  courseId        String
  orderIndex      Int

  learningPath    LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  course          Course       @relation(fields: [courseId], references: [id])

  createdAt       DateTime     @default(now())

  @@unique([learningPathId, courseId])
  @@map("learning_path_courses")
}

model UserLearningPath {
  id              String       @id @default(cuid())
  userId          String
  learningPathId  String

  currentCourseIndex Int       @default(0)
  completedCourses   Int       @default(0)
  progressPercentage Float     @default(0)

  isCompleted     Boolean      @default(false)
  completedAt     DateTime?

  user            User         @relation(fields: [userId], references: [id])
  learningPath    LearningPath @relation(fields: [learningPathId], references: [id])

  startedAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([userId, learningPathId])
  @@map("user_learning_paths")
}

// ============================================
// ANALYTICS
// ============================================

model AnalyticsEvent {
  id         String   @id @default(cuid())
  userId     String?

  eventType  String
  eventData  Json

  // Context
  ipAddress  String?
  userAgent  String?
  sessionId  String?

  createdAt  DateTime @default(now())

  @@index([eventType])
  @@index([userId])
  @@map("analytics_events")
}

// ============================================
// LIVE STREAMING & WEBINARS
// ============================================

enum LiveSessionStatus {
  SCHEDULED
  LIVE
  ENDED
  CANCELLED
}

model LiveSession {
  id          String            @id @default(cuid())
  courseId    String?
  instructorId String

  title       String
  description String?

  // Scheduling
  scheduledStartTime DateTime
  scheduledEndTime   DateTime
  actualStartTime    DateTime?
  actualEndTime      DateTime?

  // YouTube Live Integration
  youtubeVideoId String?           // YouTube video ID for live stream
  recordingUrl   String?           // URL to recording after session ends
  chatEnabled    Boolean           @default(true)

  // Settings
  status         LiveSessionStatus @default(SCHEDULED)
  maxAttendees   Int?              // Optional attendance limit
  isRecorded     Boolean           @default(true)
  allowQuestions Boolean           @default(true)

  // Relations
  instructor  User                    @relation("InstructorSessions", fields: [instructorId], references: [id])
  attendance  LiveSessionAttendance[]
  messages    LiveSessionMessage[]

  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  @@index([courseId])
  @@index([instructorId])
  @@index([scheduledStartTime])
  @@index([status])
  @@map("live_sessions")
}

model LiveSessionAttendance {
  id        String   @id @default(cuid())
  sessionId String
  userId    String

  joinedAt  DateTime @default(now())
  leftAt    DateTime?
  watchTime Int      @default(0) // seconds

  session   LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@map("live_session_attendance")
}

model LiveSessionMessage {
  id         String   @id @default(cuid())
  sessionId  String
  userId     String

  message    String
  isQuestion Boolean  @default(false) // Q&A question
  isAnswered Boolean  @default(false) // Has instructor answered
  isPinned   Boolean  @default(false) // Pinned by instructor

  session    LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@index([sessionId])
  @@index([userId])
  @@index([isQuestion])
  @@map("live_session_messages")
}

// ============================================
// MESSAGING
// ============================================

model Conversation {
  id        String   @id @default(cuid())

  // Participants
  participant1Id String
  participant2Id String

  // Last message info for quick access
  lastMessageAt  DateTime?
  lastMessageText String?

  // Read status
  participant1Unread Int @default(0)
  participant2Unread Int @default(0)

  participant1 User @relation("ConversationsAsParticipant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2 User @relation("ConversationsAsParticipant2", fields: [participant2Id], references: [id], onDelete: Cascade)

  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([participant1Id, participant2Id])
  @@index([participant1Id])
  @@index([participant2Id])
  @@map("conversations")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String

  content        String
  isRead         Boolean  @default(false)

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}

// ============================================
// MULTI-LANGUAGE SUPPORT
// ============================================

enum SupportedLocale {
  HR // Croatian
  EN // English
}

model CourseTranslation {
  id          String          @id @default(cuid())
  courseId    String
  locale      SupportedLocale

  // Translated fields
  title             String
  description       String?
  shortDescription  String?
  learningObjectives String[]
  requirements      String[]
  targetAudience    String?

  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([courseId, locale])
  @@index([courseId])
  @@map("course_translations")
}

model ModuleTranslation {
  id          String          @id @default(cuid())
  moduleId    String
  locale      SupportedLocale

  // Translated fields
  title       String
  description String?

  module      Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([moduleId, locale])
  @@index([moduleId])
  @@map("module_translations")
}

model LessonTranslation {
  id          String          @id @default(cuid())
  lessonId    String
  locale      SupportedLocale

  // Translated fields
  title       String
  description String?
  content     String?

  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([lessonId, locale])
  @@index([lessonId])
  @@map("lesson_translations")
}

// ============================================
// CONTENT VERSIONING & ROLLBACK
// ============================================

model CourseVersion {
  id          String   @id @default(cuid())
  courseId    String
  version     Int      // Incremental version number

  // Snapshot of course data at this version
  title             String
  description       String?
  shortDescription  String?
  level             String
  language          String
  duration          Int?
  price             Decimal  @db.Decimal(10, 2)
  tags              String[]
  learningObjectives String[]
  requirements      String[]
  targetAudience    String?

  // Metadata
  changeDescription String?  // What changed in this version
  createdById       String
  createdBy         User     @relation("CourseVersions", fields: [createdById], references: [id])

  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([courseId, version])
  @@index([courseId])
  @@map("course_versions")
}

model ModuleVersion {
  id          String   @id @default(cuid())
  moduleId    String
  version     Int

  // Snapshot of module data
  title       String
  description String?
  orderIndex  Int
  duration    Int?

  // Metadata
  changeDescription String?
  createdById       String
  createdBy         User     @relation("ModuleVersions", fields: [createdById], references: [id])

  module      Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([moduleId, version])
  @@index([moduleId])
  @@map("module_versions")
}

model LessonVersion {
  id          String   @id @default(cuid())
  lessonId    String
  version     Int

  // Snapshot of lesson data
  title       String
  description String?
  type        String
  orderIndex  Int
  duration    Int?
  content     String?
  contentBlocks Json?
  videoUrl    String?
  videoProvider String?
  videoDuration Int?
  attachments String[]
  isPreview   Boolean
  isMandatory Boolean
  pointsReward Int

  // Metadata
  changeDescription String?
  createdById       String
  createdBy         User     @relation("LessonVersions", fields: [createdById], references: [id])

  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([lessonId, version])
  @@index([lessonId])
  @@map("lesson_versions")
}

// ============================================
// INTERACTIVE VIDEO QUIZZES
// ============================================

model VideoQuiz {
  id          String   @id @default(cuid())
  lessonId    String

  // Quiz timing
  timestamp   Int      // When to show quiz (in seconds from video start)

  // Question content
  question    String
  options     String[] // Array of possible answers
  correctAnswer Int    // Index of correct answer (0-based)
  explanation String?  // Optional explanation shown after answering

  // Settings
  points      Int      @default(10)
  isRequired  Boolean  @default(false) // Must answer to continue video
  pauseVideo  Boolean  @default(true)  // Pause video when quiz appears

  // Relations
  lesson      Lesson             @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  responses   VideoQuizResponse[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([lessonId])
  @@index([timestamp])
  @@map("video_quizzes")
}

model VideoQuizResponse {
  id          String   @id @default(cuid())
  userId      String
  videoQuizId String

  // Response data
  answer      Int      // Selected answer index
  isCorrect   Boolean
  timeSpent   Int?     // Seconds taken to answer

  // Relations
  user        User      @relation("VideoQuizResponses", fields: [userId], references: [id], onDelete: Cascade)
  videoQuiz   VideoQuiz @relation(fields: [videoQuizId], references: [id], onDelete: Cascade)

  answeredAt  DateTime @default(now())

  @@unique([userId, videoQuizId])
  @@index([userId])
  @@index([videoQuizId])
  @@map("video_quiz_responses")
}

// ============================================
// FLASHCARDS SYSTEM
// ============================================

model FlashcardDeck {
  id          String   @id @default(cuid())

  // Basic info
  title       String
  description String?

  // Association
  courseId    String?
  lessonId    String?
  createdById String

  // Settings
  isPublic    Boolean  @default(false)
  tags        String[]

  // Relations
  course      Course?    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson      Lesson?    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  createdBy   User       @relation("FlashcardDecksCreated", fields: [createdById], references: [id])
  flashcards  Flashcard[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([courseId])
  @@index([lessonId])
  @@index([createdById])
  @@map("flashcard_decks")
}

model Flashcard {
  id          String   @id @default(cuid())
  deckId      String

  // Card content
  front       String   // Question or term
  back        String   // Answer or definition
  hint        String?  // Optional hint
  image       String?  // Optional image URL

  // Ordering
  orderIndex  Int

  // Relations
  deck        FlashcardDeck     @relation(fields: [deckId], references: [id], onDelete: Cascade)
  reviews     FlashcardReview[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([deckId])
  @@map("flashcards")
}

enum ReviewDifficulty {
  AGAIN     // Didn't remember
  HARD      // Remembered with difficulty
  GOOD      // Remembered correctly
  EASY      // Remembered easily
}

model FlashcardReview {
  id          String           @id @default(cuid())
  userId      String
  flashcardId String

  // Review data
  difficulty  ReviewDifficulty
  timeSpent   Int?             // Seconds spent on card

  // Spaced Repetition Algorithm (SM-2)
  easeFactor  Float            // Ease factor (>=1.3)
  interval    Int              // Days until next review
  repetitions Int              // Number of successful reviews

  // Next review date
  nextReview  DateTime

  // Relations
  user        User      @relation("FlashcardReviews", fields: [userId], references: [id], onDelete: Cascade)
  flashcard   Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)

  reviewedAt  DateTime @default(now())

  @@index([userId])
  @@index([flashcardId])
  @@index([nextReview])
  @@index([userId, nextReview])
  @@map("flashcard_reviews")
}

// ============================================
// STUDY GROUPS
// ============================================

enum StudyGroupRole {
  ADMIN     // Can manage group, invite members, delete
  MODERATOR // Can manage content and members
  MEMBER    // Regular member
}

model StudyGroup {
  id          String   @id @default(cuid())

  // Basic info
  name        String
  description String?
  avatar      String?  // Group avatar URL

  // Settings
  isPrivate   Boolean  @default(true)
  maxMembers  Int      @default(50)

  // Association with course (optional)
  courseId    String?

  // Relations
  course      Course?           @relation(fields: [courseId], references: [id], onDelete: SetNull)
  members     StudyGroupMember[]
  messages    StudyGroupMessage[]
  resources   StudyGroupResource[]
  sessions    StudySession[]
  invites     StudyGroupInvite[]

  createdById String
  createdBy   User     @relation("StudyGroupsCreated", fields: [createdById], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([courseId])
  @@index([createdById])
  @@map("study_groups")
}

model StudyGroupMember {
  id          String         @id @default(cuid())
  groupId     String
  userId      String

  role        StudyGroupRole @default(MEMBER)

  // Relations
  group       StudyGroup     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user        User           @relation("StudyGroupMemberships", fields: [userId], references: [id], onDelete: Cascade)

  joinedAt    DateTime       @default(now())

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@map("study_group_members")
}

model StudyGroupMessage {
  id          String     @id @default(cuid())
  groupId     String
  userId      String

  content     String
  attachments String[]   // File URLs

  // Reply support
  replyToId   String?
  replyTo     StudyGroupMessage?  @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies     StudyGroupMessage[] @relation("MessageReplies")

  // Relations
  group       StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user        User       @relation("StudyGroupMessages", fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([groupId])
  @@index([userId])
  @@map("study_group_messages")
}

model StudyGroupResource {
  id          String     @id @default(cuid())
  groupId     String
  userId      String

  // Resource info
  title       String
  description String?
  type        String     // 'file', 'link', 'note'
  url         String?    // File URL or external link
  content     String?    // For notes

  // Relations
  group       StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user        User       @relation("StudyGroupResources", fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([groupId])
  @@index([userId])
  @@map("study_group_resources")
}

model StudySession {
  id          String     @id @default(cuid())
  groupId     String

  // Session info
  title       String
  description String?
  scheduledAt DateTime
  duration    Int        // Minutes
  meetingUrl  String?    // Video call link

  // Relations
  group       StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  createdById String
  createdBy   User       @relation("StudySessionsCreated", fields: [createdById], references: [id])

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([groupId])
  @@index([scheduledAt])
  @@map("study_sessions")
}

model StudyGroupInvite {
  id          String     @id @default(cuid())
  groupId     String
  invitedById String

  // Invite details
  email       String?    // Email to invite
  token       String     @unique // Unique invite token
  expiresAt   DateTime

  // Status
  usedAt      DateTime?
  usedById    String?

  // Relations
  group       StudyGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  invitedBy   User       @relation("StudyGroupInvitesSent", fields: [invitedById], references: [id])

  createdAt   DateTime   @default(now())

  @@index([groupId])
  @@index([token])
  @@map("study_group_invites")
}

// ============================================
// LEARNING STREAKS & DAILY GOALS
// ============================================

model LearningStreak {
  id            String   @id @default(cuid())
  userId        String   @unique

  // Current streak
  currentStreak Int      @default(0)
  longestStreak Int      @default(0)
  lastActivityDate DateTime?

  // Daily goals
  dailyGoalMinutes Int   @default(15) // Default 15 minutes per day
  dailyGoalLessons Int   @default(1)  // Default 1 lesson per day

  // Streak protection
  freezeDaysAvailable Int @default(0) // Days you can miss without losing streak
  freezeDaysUsed      Int @default(0)

  // Statistics
  totalDaysActive     Int @default(0)
  totalMinutesLearned Int @default(0)
  totalLessonsCompleted Int @default(0)

  // Achievements
  streakMilestones    Int[] @default([]) // Achieved milestones: 7, 30, 100, 365 days

  // Relations
  user          User     @relation("UserLearningStreak", fields: [userId], references: [id], onDelete: Cascade)
  dailyActivities DailyActivity[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([currentStreak])
  @@map("learning_streaks")
}

model DailyActivity {
  id            String   @id @default(cuid())
  streakId      String
  date          DateTime @db.Date // Just the date, no time

  // Activity metrics
  minutesLearned Int     @default(0)
  lessonsCompleted Int   @default(0)
  quizzesCompleted Int   @default(0)
  pointsEarned   Int     @default(0)

  // Goal completion
  goalMet       Boolean  @default(false)
  usedFreeze    Boolean  @default(false)

  // Activity breakdown
  courseActivities Json? // { courseId: { minutes: number, lessons: number } }

  // Relations
  streak        LearningStreak @relation(fields: [streakId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([streakId, date])
  @@index([streakId])
  @@index([date])
  @@map("daily_activities")
}

model StreakReward {
  id            String   @id @default(cuid())
  userId        String

  // Reward info
  milestone     Int      // 7, 30, 100, 365, etc.
  rewardType    String   // 'badge', 'points', 'freeze_day', 'discount'
  rewardValue   String   // Badge ID, points amount, etc.
  claimedAt     DateTime?

  // Relations
  user          User     @relation("UserStreakRewards", fields: [userId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())

  @@unique([userId, milestone])
  @@index([userId])
  @@map("streak_rewards")
}

// ============================================
// PEER TUTORING & MENTORSHIP
// ============================================

enum TutorStatus {
  PENDING     // Application pending review
  APPROVED    // Approved to tutor
  SUSPENDED   // Temporarily suspended
  REJECTED    // Application rejected
}

enum TutoringSessionStatus {
  REQUESTED   // Student requested session
  ACCEPTED    // Tutor accepted
  SCHEDULED   // Time confirmed
  IN_PROGRESS // Session ongoing
  COMPLETED   // Session finished
  CANCELLED   // Cancelled by either party
  NO_SHOW     // One party didn't show up
}

enum TutoringRequestStatus {
  OPEN        // Looking for tutor
  MATCHED     // Found tutor
  IN_PROGRESS // Currently being tutored
  RESOLVED    // Help received
  CLOSED      // Closed without resolution
}

model TutorProfile {
  id            String       @id @default(cuid())
  userId        String       @unique

  // Profile info
  headline      String?      // Short bio/tagline
  bio           String?      // Detailed description
  hourlyRate    Decimal?     @db.Decimal(10, 2) // Optional - can be free
  currency      String       @default("EUR")

  // Expertise
  subjects      String[]     // Areas of expertise
  courseIds     String[]     // Courses they can tutor in
  languages     String[]     @default(["hr"]) // Languages they can tutor in

  // Availability
  availableHours Json?       // { monday: [{start: "09:00", end: "17:00"}], ... }
  timezone      String       @default("Europe/Zagreb")
  maxSessionsPerWeek Int?    // Optional limit

  // Qualifications
  qualifications String[]    // Certifications, degrees
  experience    String?      // Years/description of experience

  // Stats
  totalSessions Int          @default(0)
  totalHours    Float        @default(0)
  averageRating Float?
  totalReviews  Int          @default(0)
  responseRate  Float?       // % of requests responded to
  responseTime  Int?         // Average response time in minutes

  // Status
  status        TutorStatus  @default(PENDING)
  isAvailable   Boolean      @default(true) // Currently accepting students
  isFeatured    Boolean      @default(false) // Featured tutor

  // Verification
  verifiedAt    DateTime?
  verifiedBy    String?      // Admin who verified

  // Relations
  user          User         @relation("TutorProfile", fields: [userId], references: [id], onDelete: Cascade)
  sessions      TutoringSession[] @relation("TutorSessions")
  reviews       TutoringReview[] @relation("TutorReviews")
  applications  TutorApplication[] @relation("TutorApplications")
  matchedRequests TutoringRequest[] @relation("MatchedTutoringRequests")

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([userId])
  @@index([status])
  @@index([isAvailable])
  @@index([averageRating])
  @@map("tutor_profiles")
}

model TutoringRequest {
  id            String                 @id @default(cuid())
  studentId     String

  // Request details
  title         String
  description   String
  subject       String                 // Topic area
  courseId      String?                // Related course
  lessonId      String?                // Related lesson

  // Preferences
  preferredLanguage String?
  urgency       String                 @default("normal") // low, normal, high, urgent
  budgetMin     Decimal?               @db.Decimal(10, 2)
  budgetMax     Decimal?               @db.Decimal(10, 2)
  preferredSchedule Json?              // Preferred times

  // Status
  status        TutoringRequestStatus  @default(OPEN)

  // Matching
  matchedTutorId String?
  matchedAt     DateTime?

  // Relations
  student       User                   @relation("StudentTutoringRequests", fields: [studentId], references: [id], onDelete: Cascade)
  matchedTutor  TutorProfile?          @relation("MatchedTutoringRequests", fields: [matchedTutorId], references: [id], onDelete: SetNull)
  sessions      TutoringSession[]
  applications  TutorApplication[]

  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  expiresAt     DateTime?

  @@index([studentId])
  @@index([status])
  @@index([subject])
  @@index([courseId])
  @@map("tutoring_requests")
}

model TutorApplication {
  id            String           @id @default(cuid())
  requestId     String
  tutorId       String

  // Application details
  message       String           // Tutor's pitch/introduction
  proposedRate  Decimal?         @db.Decimal(10, 2)
  proposedSchedule Json?         // Proposed meeting times

  // Status
  status        String           @default("pending") // pending, accepted, rejected, withdrawn

  // Relations
  request       TutoringRequest  @relation(fields: [requestId], references: [id], onDelete: Cascade)
  tutor         TutorProfile     @relation("TutorApplications", fields: [tutorId], references: [id], onDelete: Cascade)

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@unique([requestId, tutorId])
  @@index([requestId])
  @@index([tutorId])
  @@map("tutor_applications")
}

model TutoringSession {
  id            String                  @id @default(cuid())
  tutorId       String
  studentId     String
  requestId     String?

  // Session details
  title         String
  description   String?
  subject       String

  // Scheduling
  scheduledAt   DateTime
  duration      Int                     // Minutes
  actualStartTime DateTime?
  actualEndTime DateTime?

  // Meeting info
  meetingUrl    String?                 // Video call link
  meetingProvider String?               // zoom, meet, teams, etc.
  meetingRoomId String?                 // For internal video system

  // Status
  status        TutoringSessionStatus   @default(REQUESTED)
  cancelReason  String?
  cancelledBy   String?

  // Payment (if applicable)
  rate          Decimal?                @db.Decimal(10, 2)
  totalCost     Decimal?                @db.Decimal(10, 2)
  isPaid        Boolean                 @default(false)
  paymentId     String?

  // Notes
  tutorNotes    String?                 // Private notes from tutor
  sessionNotes  String?                 // Shared session notes
  homework      String?                 // Assigned homework/tasks

  // Resources shared during session
  resources     Json?                   // [{name, url, type}]

  // Relations
  tutor         TutorProfile            @relation("TutorSessions", fields: [tutorId], references: [id], onDelete: Cascade)
  student       User                    @relation("StudentSessions", fields: [studentId], references: [id], onDelete: Cascade)
  request       TutoringRequest?        @relation(fields: [requestId], references: [id], onDelete: SetNull)
  review        TutoringReview?
  messages      TutoringMessage[]

  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt

  @@index([tutorId])
  @@index([studentId])
  @@index([status])
  @@index([scheduledAt])
  @@map("tutoring_sessions")
}

model TutoringMessage {
  id            String           @id @default(cuid())
  sessionId     String
  senderId      String

  content       String
  attachments   String[]

  isRead        Boolean          @default(false)
  readAt        DateTime?

  // Relations
  session       TutoringSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt     DateTime         @default(now())

  @@index([sessionId])
  @@index([senderId])
  @@map("tutoring_messages")
}

model TutoringReview {
  id            String           @id @default(cuid())
  sessionId     String           @unique
  tutorId       String
  studentId     String

  // Ratings (1-5)
  overallRating Int
  knowledgeRating Int?           // Subject knowledge
  communicationRating Int?       // Communication skills
  punctualityRating Int?         // On-time and prepared
  helpfulnessRating Int?         // How helpful was the session

  // Review content
  comment       String?

  // Tutor response
  tutorResponse String?
  tutorRespondedAt DateTime?

  // Visibility
  isPublic      Boolean          @default(true)

  // Relations
  session       TutoringSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tutor         TutorProfile     @relation("TutorReviews", fields: [tutorId], references: [id], onDelete: Cascade)
  student       User             @relation("StudentTutoringReviews", fields: [studentId], references: [id], onDelete: Cascade)

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([tutorId])
  @@index([studentId])
  @@map("tutoring_reviews")
}

// ============================================
// LEARNING CHALLENGES & COMPETITIONS
// ============================================

enum ChallengeType {
  DAILY       // Complete daily tasks
  WEEKLY      // Week-long challenge
  MONTHLY     // Month-long challenge
  SPECIAL     // Limited-time event
  COURSE      // Course-specific challenge
  COMMUNITY   // Community-wide challenge
}

enum ChallengeStatus {
  DRAFT       // Not yet published
  UPCOMING    // Scheduled but not started
  ACTIVE      // Currently running
  COMPLETED   // Finished
  CANCELLED   // Cancelled before completion
}

enum ChallengeGoalType {
  LESSONS_COMPLETED   // Complete X lessons
  MINUTES_LEARNED     // Study for X minutes
  QUIZZES_PASSED      // Pass X quizzes
  COURSES_COMPLETED   // Complete X courses
  STREAK_DAYS         // Maintain X day streak
  POINTS_EARNED       // Earn X points
  PERFECT_SCORES      // Get X perfect quiz scores
  FLASHCARDS_REVIEWED // Review X flashcards
  FORUM_POSTS         // Create X forum posts
  CUSTOM              // Custom criteria
}

model Challenge {
  id            String           @id @default(cuid())

  // Basic info
  title         String
  description   String
  shortDescription String?
  thumbnail     String?

  // Type and timing
  type          ChallengeType
  status        ChallengeStatus  @default(DRAFT)
  startDate     DateTime
  endDate       DateTime

  // Goal configuration
  goalType      ChallengeGoalType
  goalTarget    Int              // Target number to achieve
  goalConfig    Json?            // Additional configuration { courseId?, categoryId?, etc }

  // Rewards
  pointsReward  Int              @default(100)
  badgeId       String?          // Badge awarded on completion
  otherRewards  Json?            // { type: 'discount', value: '20%' }, etc.

  // Restrictions
  maxParticipants Int?           // null = unlimited
  minLevel      Int?             // Minimum user level to participate
  courseId      String?          // If course-specific
  isPublic      Boolean          @default(true)

  // Statistics
  participantCount Int           @default(0)
  completionCount  Int           @default(0)

  // Creator
  createdById   String

  // Relations
  participants  ChallengeParticipant[]
  leaderboard   ChallengeLeaderboard[]

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([type])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@map("challenges")
}

model ChallengeParticipant {
  id            String    @id @default(cuid())
  challengeId   String
  userId        String

  // Progress
  currentProgress Int     @default(0)
  isCompleted   Boolean   @default(false)
  completedAt   DateTime?

  // Tracking
  lastActivityAt DateTime?
  progressHistory Json?   // Array of { date, progress } for charting

  // Rewards claimed
  rewardsClaimed Boolean  @default(false)
  claimedAt     DateTime?

  // Relations
  challenge     Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user          User      @relation("UserChallenges", fields: [userId], references: [id], onDelete: Cascade)

  joinedAt      DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([challengeId, userId])
  @@index([challengeId])
  @@index([userId])
  @@index([isCompleted])
  @@map("challenge_participants")
}

model ChallengeLeaderboard {
  id            String    @id @default(cuid())
  challengeId   String
  userId        String

  // Ranking data
  rank          Int
  score         Int       // Progress or points
  completionTime Int?     // Seconds to complete (for speed rankings)

  // Snapshot at ranking time
  snapshotAt    DateTime  @default(now())

  // Relations
  challenge     Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user          User      @relation("UserChallengeLeaderboard", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userId])
  @@index([challengeId])
  @@index([rank])
  @@map("challenge_leaderboards")
}

// Team-based competitions
model Team {
  id            String    @id @default(cuid())

  name          String
  description   String?
  avatar        String?

  // Stats
  totalPoints   Int       @default(0)
  memberCount   Int       @default(0)

  // Settings
  isPublic      Boolean   @default(true)
  maxMembers    Int       @default(10)

  // Creator
  captainId     String

  // Relations
  members       TeamMember[]
  competitions  TeamCompetitionParticipant[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([captainId])
  @@map("teams")
}

model TeamMember {
  id            String    @id @default(cuid())
  teamId        String
  userId        String

  role          String    @default("member") // captain, co-captain, member
  contributedPoints Int   @default(0)

  // Relations
  team          Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user          User      @relation("UserTeamMemberships", fields: [userId], references: [id], onDelete: Cascade)

  joinedAt      DateTime  @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

model TeamCompetition {
  id            String    @id @default(cuid())

  title         String
  description   String

  // Timing
  startDate     DateTime
  endDate       DateTime
  status        ChallengeStatus @default(DRAFT)

  // Goal
  goalType      ChallengeGoalType
  goalDescription String?

  // Rewards
  firstPlaceReward  Json?  // { points, badge, other }
  secondPlaceReward Json?
  thirdPlaceReward  Json?
  participationReward Json?

  // Restrictions
  minTeamSize   Int       @default(2)
  maxTeamSize   Int       @default(10)
  maxTeams      Int?

  // Stats
  teamCount     Int       @default(0)

  // Relations
  participants  TeamCompetitionParticipant[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status])
  @@index([startDate])
  @@map("team_competitions")
}

model TeamCompetitionParticipant {
  id              String          @id @default(cuid())
  competitionId   String
  teamId          String

  // Progress
  totalScore      Int             @default(0)
  rank            Int?

  // Relations
  competition     TeamCompetition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  team            Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)

  joinedAt        DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([competitionId, teamId])
  @@index([competitionId])
  @@index([teamId])
  @@map("team_competition_participants")
}

// ============================================
// ACTIVITY FEED & SOCIAL FEATURES
// ============================================

enum ActivityType {
  COURSE_ENROLLED     // User enrolled in a course
  COURSE_COMPLETED    // User completed a course
  LESSON_COMPLETED    // User completed a lesson
  QUIZ_PASSED         // User passed a quiz
  BADGE_EARNED        // User earned a badge
  CERTIFICATE_EARNED  // User earned a certificate
  STREAK_MILESTONE    // User reached streak milestone
  CHALLENGE_JOINED    // User joined a challenge
  CHALLENGE_COMPLETED // User completed a challenge
  LEVEL_UP            // User leveled up
  REVIEW_POSTED       // User posted a review
  FORUM_POST          // User created forum post
  STUDY_GROUP_JOINED  // User joined study group
  TUTOR_SESSION       // User completed tutoring session
  ACHIEVEMENT_UNLOCKED // User unlocked an achievement
}

model UserFollow {
  id          String   @id @default(cuid())
  followerId  String   // User who is following
  followingId String   // User being followed

  // Relations
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("user_follows")
}

model Activity {
  id          String       @id @default(cuid())
  userId      String

  // Activity details
  type        ActivityType
  title       String
  description String?

  // Related entities (optional, depends on type)
  courseId    String?
  lessonId    String?
  badgeId     String?
  challengeId String?
  achievementId String?

  // Additional data
  metadata    Json?        // { points: 100, level: 5, etc }

  // Visibility
  isPublic    Boolean      @default(true)

  // Engagement
  likesCount  Int          @default(0)
  commentsCount Int        @default(0)

  // Relations
  user        User         @relation("UserActivities", fields: [userId], references: [id], onDelete: Cascade)
  likes       ActivityLike[]
  comments    ActivityComment[]

  createdAt   DateTime     @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([isPublic])
  @@map("activities")
}

model ActivityLike {
  id          String   @id @default(cuid())
  activityId  String
  userId      String

  // Relations
  activity    Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user        User     @relation("UserActivityLikes", fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([activityId, userId])
  @@index([activityId])
  @@index([userId])
  @@map("activity_likes")
}

model ActivityComment {
  id          String   @id @default(cuid())
  activityId  String
  userId      String

  content     String

  // Reply support
  parentId    String?
  parent      ActivityComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     ActivityComment[] @relation("CommentReplies")

  // Relations
  activity    Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  user        User     @relation("UserActivityComments", fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([activityId])
  @@index([userId])
  @@index([parentId])
  @@map("activity_comments")
}

// User profile enhancements for social features
model UserProfile {
  id              String   @id @default(cuid())
  userId          String   @unique

  // Social stats
  followersCount  Int      @default(0)
  followingCount  Int      @default(0)
  activitiesCount Int      @default(0)

  // Privacy settings
  showActivity    Boolean  @default(true)
  showProgress    Boolean  @default(true)
  showBadges      Boolean  @default(true)
  allowFollow     Boolean  @default(true)

  // Profile customization
  coverImage      String?
  socialLinks     Json?    // { twitter, linkedin, github }
  interests       String[] // Learning interests/topics

  // Relations
  user            User     @relation("UserSocialProfile", fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@map("user_profiles")
}

// ============================================
// ADVANCED NOTIFICATION SYSTEM
// ============================================

enum NotificationChannel {
  IN_APP      // In-app notifications
  EMAIL       // Email notifications
  PUSH        // Push notifications (web/mobile)
  SMS         // SMS notifications (optional)
}

enum NotificationCategory {
  LEARNING    // Course progress, completions
  SOCIAL      // Follows, likes, comments
  ACHIEVEMENT // Badges, streaks, challenges
  REMINDER    // Study reminders, deadlines
  SYSTEM      // Platform updates, maintenance
  MARKETING   // Promotions, new courses
}

enum ReminderFrequency {
  ONCE        // One-time reminder
  DAILY       // Every day
  WEEKLY      // Every week
  CUSTOM      // Custom schedule
}

model NotificationPreferences {
  id              String   @id @default(cuid())
  userId          String   @unique

  // Global settings
  enabled         Boolean  @default(true)
  quietHoursStart String?  // "22:00"
  quietHoursEnd   String?  // "08:00"
  timezone        String   @default("Europe/Zagreb")

  // Channel preferences
  emailEnabled    Boolean  @default(true)
  pushEnabled     Boolean  @default(true)
  smsEnabled      Boolean  @default(false)

  // Category preferences (JSON for flexibility)
  // { learning: { inApp: true, email: true, push: false }, ... }
  categorySettings Json?

  // Email digest settings
  emailDigestEnabled Boolean @default(true)
  emailDigestFrequency String @default("daily") // daily, weekly, never
  emailDigestDay    Int?     // 0-6 for weekly (0=Sunday)
  emailDigestTime   String   @default("09:00")
  lastDigestSentAt  DateTime?

  // Relations
  user            User     @relation("UserNotificationPrefs", fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@map("notification_preferences")
}

model PushSubscription {
  id              String   @id @default(cuid())
  userId          String

  // Web Push subscription data
  endpoint        String
  p256dh          String   // Public key
  auth            String   // Auth secret

  // Device info
  deviceType      String?  // web, android, ios
  deviceName      String?
  userAgent       String?

  // Status
  isActive        Boolean  @default(true)
  lastUsedAt      DateTime?
  failureCount    Int      @default(0)

  // Relations
  user            User     @relation("UserPushSubscriptions", fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, endpoint])
  @@index([userId])
  @@index([isActive])
  @@map("push_subscriptions")
}

model ScheduledReminder {
  id              String            @id @default(cuid())
  userId          String

  // Reminder details
  title           String
  message         String
  type            String            // study, deadline, custom

  // Scheduling
  frequency       ReminderFrequency @default(ONCE)
  scheduledTime   String            // "09:00"
  scheduledDays   Int[]             // [1,2,3,4,5] = Mon-Fri for weekly
  nextRunAt       DateTime
  lastRunAt       DateTime?

  // Target (optional)
  courseId        String?
  lessonId        String?

  // Channels
  channels        NotificationChannel[]

  // Status
  isActive        Boolean           @default(true)
  runCount        Int               @default(0)
  maxRuns         Int?              // null = unlimited

  // Relations
  user            User              @relation("UserScheduledReminders", fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId])
  @@index([nextRunAt])
  @@index([isActive])
  @@map("scheduled_reminders")
}

model NotificationTemplate {
  id              String   @id @default(cuid())

  // Template info
  name            String   @unique
  category        NotificationCategory
  channel         NotificationChannel

  // Content templates (support variables like {{userName}})
  subject         String?  // For email
  title           String
  body            String
  actionUrl       String?
  actionText      String?

  // Rich content
  icon            String?
  image           String?

  // Settings
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([category])
  @@index([channel])
  @@map("notification_templates")
}

model NotificationLog {
  id              String              @id @default(cuid())
  userId          String

  // Notification details
  category        NotificationCategory
  channel         NotificationChannel
  templateId      String?

  title           String
  body            String
  actionUrl       String?

  // Delivery status
  status          String              @default("pending") // pending, sent, delivered, failed, clicked
  sentAt          DateTime?
  deliveredAt     DateTime?
  clickedAt       DateTime?
  failureReason   String?

  // Metadata
  metadata        Json?               // Additional context data

  // Relations
  user            User                @relation("UserNotificationLogs", fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime            @default(now())

  @@index([userId])
  @@index([category])
  @@index([status])
  @@index([createdAt])
  @@map("notification_logs")
}

model EmailDigestQueue {
  id              String   @id @default(cuid())
  userId          String

  // Digest content (accumulated items)
  items           Json     // Array of digest items
  itemCount       Int      @default(0)

  // Scheduling
  scheduledFor    DateTime
  processedAt     DateTime?

  // Status
  status          String   @default("pending") // pending, processing, sent, failed

  // Relations
  user            User     @relation("UserEmailDigests", fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([scheduledFor])
  @@index([status])
  @@map("email_digest_queue")
}
